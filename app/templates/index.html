{% extends "layout.html" %}

{% block body %}

<!-- {% if error %}<p class="error"><strong>Hey: </strong> {{ error }}{% endif %} -->

<!-- responsive web design tag to adjust for all devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
	#tobii-cursor {
		position: absolute;
		width: 20px;
		height: 20px;
		background-color: red;
		border-radius: 50%;
		pointer-events: none;
		z-index: 9999;
		box-shadow: 0 0 8px rgba(255, 0, 0, 0.5);
	}

</style>

<style>
	#dwell-ring {
	  position: absolute;
	  width: 40px;
	  height: 40px;
	  border-radius: 50%;
	  border: 3px solid rgba(0, 150, 255, 0.6);
	  box-shadow: 0 0 6px rgba(0, 150, 255, 0.3);
	  pointer-events: none;
	  z-index: 9998;
	  display: none;
	}
  
	#dwell-ring.fill {
	  animation: dwellFill 2s linear forwards;
	}
  
	@keyframes dwellFill {
	  0% {
		transform: scale(1);
		border-color: rgba(0, 150, 255, 0.6);
	  }
	  100% {
		transform: scale(1.6);
		border-color: rgba(0, 255, 0, 1);
	  }
	}
.suggested-query {
	background-color: #e0e0e0;
	border: none;
	color: #333;
	padding: 8px 12px;
	margin: 5px;
	cursor: pointer;
	border-radius: 6px;
	font-size: 14px;
	transition: background-color 0.3s ease;
}

.suggested-query:hover {
	background-color: #cde4f7;
}
  </style>
  


<div style=background-color:white class=container_search>
	<form name="Go" action="" method="POST" enctype="multipart/form-data" id="usrform">
		<dl>
			<dt>
				<!-- change input to value="{{ query }}" for non-voice -->
				<input type="text" name="query" id="query-primary" value="{{ query }}" autofocus
					data-intro='Input your search term here.' />
				<!-- speech recognition -->
				<!--<script>
					covid-19 alert
					alert("The COVID-19 Open Research Dataset (CORD-19) is now an option within PATTIE. You can use search terms, but a query is not required.\n\nThis dataset is part of the Call to Action on the tech community requested by The White House Office of Science and Technology Policy.\n\nThe dataset represents the most extensive machine-readable Coronavirus literature collection available for data and text mining to date with more than 13,000 full text articles.")
					</script>-->
			</dt>
			<!-- Make bottom div hidden -->
			<div class='select' style="display:none">
				<select style=text-align:center;color:grey;background-color:white;opacity:0.80 name="dataset_opt"
					id='dataset_opt' onChange='changeField(this.value)' data-intro='- Select your dataset here. <dt>
																																															- Note that you may upload your own dataset by selecting "upload".'>
					<option value="PostgreSQL">PostgreSQL</option>
					<option value="PubMedAPI">PubMed</option>
					<option value="DigiSquare">Digital Square</option>
					<option value="NewsAPI">News</option>
					<option value="Experts">Academic Experts</option>
				</select>
				<div class="select__arrow" id="select_arrow" style="display: none;"></div>

				</div>


				<!-- <div class="select" onClick='hideOption()' style="width:100%; display: inline-block;"> -->
				<div class="select" style="display: none;">
					<select style="color:#7b7b7b;opacity: 0.7;background-color:white;width:100%;text-align:center"
						name="num_cls" id="num_cls" onChange='changeClusterNumber(this.value)'
						data-intro='You can also specify the number of clusters you want to see!'>
						<option id="cluster_option" value="5">Default: 5 Clusters</option>
						<option value="2">2 Clusters</option>
						<option value="3">3 Clusters</option>
						<option value="4">4 Clusters</option>
						<option value="5">5 Clusters</option>
						<option value="6">6 Clusters</option>
						<option value="7">7 Clusters</option>
						<option value="8">8 Clusters</option>
						<option value="9">9 Clusters</option>
						<option value="10">10 Clusters</option>
					</select>
					<div class="select__arrow" id="select_arrow" style="display: none;">

					</div>
				</div>
				<!-- <div>
					<p style="text-align:center;color:#000000;opacity: 0.7;background-color:white;width:100%;text-align:center">
						<b>Suggested Query Terms:</b> Election, America, Africa, Football, Tennis, Money</p>
				</div>
				<div>
					<input id='Explore'
						style="background:#4c6d92 ;color:white;opacity:.70;display:inline-block;height:50px" type=submit
						value="Search" data-intro='Now search and see the clusters!'>
				</div> -->
				<div style="text-align:center">
					<!-- <p style="color:#000000; opacity:0.7; background-color:white; margin-bottom: 10px;">
						<b>Suggested Query Terms:</b> America, Africa, Football, Tennis, Premier League
					</p> -->
					<div style="margin-bottom: 50px;">
						<b style="color:#000000; opacity:0.7;">Suggested Query Terms:</b><br><br>
						<button type="button" class="suggested-query" data-query="Canada">Canada</button>
						<button type="button" class="suggested-query" data-query="Africa">Africa</button>
						<button type="button" class="suggested-query" data-query="Finance">Finance</button>
						<button type="button" class="suggested-query" data-query="Tennis">Tennis</button>
					</div>
					<div>


						<input id="Explore"
							   style="background:#4c6d92; color:white; opacity:0.70; height:75px; width:150px; border:none; cursor:pointer;"
							   type="submit"
							   value="Search"
							   data-intro='Now search and see the clusters!'>
					</div>
				</div>				
				<div class='select'>
					<select name="field" id='field' data-intro='Then specify your field.' style="visibility:hidden">
						<option value="All fields" defaultOpen>All fields</option>
					</select>
					<!--<div class="select__arrow"></div>-->
				</div>
				<div>
					<input type="file" id="inputfile" name="inputfile" style="visibility:hidden">
					<button type="button" id="delete" style="visibility:hidden">Delete File</button>
					<button type="button" onclick="redirectUpload()" id="upload" style="visibility:hidden">Upload
						Data</button>
				</div>
		</dl>
	</form>
</div>
<div id="tobii-cursor"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
<script src="https://cdn.socket.io/4.3.2/socket.io.min.js"></script>
<script>
    const socket = io("http://localhost:5000"); // Update if hosted elsewhere
    socket.emit("start_gaze");

    const cursor = document.getElementById("tobii-cursor");
    let targetX = 0, targetY = 0;
    let currentX = 0, currentY = 0;

    socket.on("gaze_data", data => {
        if (data.x < 0 || data.x > 1 || data.y < 0 || data.y > 1) return;
        targetX = data.x * window.innerWidth;
        targetY = data.y * window.innerHeight;
    });

    function moveCursorSmoothly() {
        const smoothing = 0.15;
        currentX += (targetX - currentX) * smoothing;
        currentY += (targetY - currentY) * smoothing;
        cursor.style.left = `${currentX}px`;
        cursor.style.top = `${currentY}px`;
        requestAnimationFrame(moveCursorSmoothly);
    }

    moveCursorSmoothly();

	// Adding click simulation
	let lastElement = null;
	let hoverTimeout = null;
	const hoverTimeThreshold = 1000; // milliseconds

	function checkGazeHoverTrigger() {
		const element = document.elementFromPoint(currentX, currentY);

		// if (element && element.tagName.toLowerCase() === "circle" && element.classList.contains("cover") || (element && element.id === "zoom-in-button") || (element && element.id === "zoom-out-button") || (element && element.id === "Explore") || (element && element.id === "num_cls")) {
			if (
				element &&
				(
					(element.tagName.toLowerCase() === "circle" && element.classList.contains("cover")) ||
					element.id === "zoom-in-button" ||
					element.id === "zoom-out-button" ||
					element.id === "Explore" ||
					element.id === "num_cls" ||
					element.classList.contains("suggested-query")
				)
			) {

			if (element !== lastElement) {
				// New element: reset hover timer
				if (hoverTimeout) clearTimeout(hoverTimeout);

				hoverTimeout = setTimeout(() => {
					console.log("Hovered over:", element);
					// element.dispatchEvent(new MouseEvent("click", {
					// 	bubbles: true,
					// 	cancelable: true,
					// 	button: 0
					// }));
					if (element.tagName.toLowerCase() === "select") {
						// For dropdowns, open/focus it
						element.focus();
						element.size = element.options.length; // optional: expand dropdown on gaze
					} else {
						element.dispatchEvent(new MouseEvent("click", {
							bubbles: true,
							cancelable: true,
							button: 0
						}));
						console.log("Simulated click on:", element);
					}
					// console.log("Simulated click on:", element);
				}, hoverTimeThreshold);

				lastElement = element;
			}
		} else {
			// Gaze moved off a valid element
			if (hoverTimeout) clearTimeout(hoverTimeout);
			lastElement = null;
		}

		requestAnimationFrame(checkGazeHoverTrigger);
	}

	checkGazeHoverTrigger();

</script>


<script>
	document.querySelectorAll('.suggested-query').forEach(btn => {
		btn.addEventListener('click', () => {
			const query = btn.getAttribute('data-query');
			document.getElementById('query-primary').value = query;
		});
	});
</script>




<script>
	let uploaded_files = {{ uploaded_files| safe}}
	let clusterUrl = {{ url_for('cluster') | tojson}}
	let deleteFileUrl = {{ url_for('delete_file') | tojson}}
</script>
<script src="{{url_for('static', filename='index.js')}}"></script>


{% endblock %}
