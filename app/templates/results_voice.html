{% extends "layout_voice.html" %}

{% block body %}

<!-- responsive web design tag to adjust for all devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
.hide {
	display: none
}
</style>

<script type=text/javascript charset="utf-8">
	document.getElementById("menu").style="top:0px; text-align:right; left:-1%";
	document.getElementById("main_heading").style="magin:10px; text-align:left; ";
	document.getElementsByClassName("page")[0].style="height:90%"
	console.log(document.getElementsByClassName("page")[0].style);
//changing the heading for each page
//document.getElementById("heading1").style= "margin-left:-330px";
//console.log('{{dataset}}');
//document.getElementById("tutorial").innerHTML= "<a href='{{url_for('static', filename='about.html')}}' class='text_link' onclick=\"return !window.open(this.href, 'tutorial', 'width=800,height=600')\" target=\"_blank\" style='text-align:left; margin-left:-1175px'>About</a>\
	//                                              <dt><a href=# class='text_link' style='text-align:left; margin-left:-1070px' onclick='tutorial()'>A Step-by-Step Intro </a>";



//global functions
//click on tutorials
function tutorial(){
	introJs().start();
}

//show uploaded articles in a new window
function show_uploaded_articles(article,link_id){
	//var myWindow = window.close()
	var myWindow = window.open('', 'TextWindow', 'width=1000,height=700');
	//var myWindow = window.open('', '_self');
	myWindow.document.body.innerHTML='';
	//console.log(myWindow.document.body.innerHTML)
	var article_to_show=article;
 //console.log(article_to_show);
	article_to_show=article_to_show.replace(/_startinganewline_/g, '<br>');
	article_to_show=article_to_show.replace(/_singlequote_/g, "'");
	article_to_show=article_to_show.replace(/_doublequote_/g, '"');
 //console.log(article_to_show);
	myWindow.document.write('<p>'+article_to_show+'</p>');
 //console.log("color is " + document.getElementById(link_id).style.color)
	document.getElementById(link_id).style.color = "#551A8B";

}

//go home
function goHome(){
	window.history.back();
}

//open the panel for documents when click on the tab/bubble
function openDoc(evt, docName, keywordsName, id) {
	// Declare all variables
	var i, tabcontent, tablinks, keywords;
	// Get all elements with class="keywords" and hide them
	keywords = document.getElementsByClassName("keywords");
	for (i = 0; i < keywords.length; i++) {
		keywords[i].style.display = "none";

	}

	// Get all elements with class="tabcontent" and hide them
	tabcontent = document.getElementsByClassName("tabcontent");
	for (i = 0; i < tabcontent.length; i++) {
		tabcontent[i].style.display = "none";
	}

	// Get all elements with class="tablinks" and remove the class "active"
	tablinks = document.getElementsByClassName("tablinks");
	for (i = 0; i < tablinks.length; i++) {
	 //console.log(i)
		tablinks[i].className = tablinks[i].className.replace(" active", "");
	}

	// Show the current tab, and add an "active" class to the button that opened the tab
	document.getElementById(keywordsName).style.display = "block";
	document.getElementById(docName).style.display = "block";
	evt.currentTarget.className += " active";

 //console.log("circle is "+ id);
	d3.selectAll('circle').each(function(d){
		if (d.id == id){
		this.style = "stroke:gray"
	}else{
		this.style.stroke = "none";
	}

	});
	//else if (this.style.filter == "url(\"#f1\")"){
		//this.style.filter = "none"}
	//


	//console.log(d3.select("circle#" + id));
};

//open the linked page in a floating window
$("a.new_link").on("click", function() {
	var new_link = $(this).prop('href');
 //console.log(new_link);
	window.open(new_link, "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=500,left=500,width=400,height=400");
});

function harmonic_mean (a, b ) {
		return (2 * a * b / (a+b) ) ;
};

//modify data
function modify_data (data, width, height) {

	var modified_data = [];
	var num_item = data.length ;
	var num_documents = 0 ;


	for (var i= 0 ; i < num_item ; i++) {
			num_documents += data[i].count;
	}

	for (var i= 0 ; i < num_item ; i++) {

			var short_keywords = shorten(data[i].keywords, data[i].count);
			var num_short_item = short_keywords.length;
			for (var j=0 ; j < num_short_item + 1; j++) {
					temp_item = {} ;
					temp_item.id = i;
					temp_item.size = Math.sqrt(harmonic_mean(data[i].count/num_documents, shorten(data[i].keywords, data[i].count).length)) / 5 * 39 * 5;
					// Math.sqrt(harmonic_mean(data[i].count, shorten(data[i].keywords, data[i].count).length)) / 5 * 35;
					if ( j ==  num_short_item ) {
							// temp_item.keyword = "(" + data[i].count.toString() + ")";
							temp_item.x = 200 + data[i].cx*0.75 * (width - 200);// - data[i].count.toString().length/2*temp_item.size/2;
					} else {
							temp_item.keyword = short_keywords[j].replace(" ", "");
							temp_item.x = 200 + data[i].cx*0.75 * (width - 200); // - short_keywords[j].length/2*temp_item.size/Math.sqrt(short_keywords[j].length/2) ;
					}
					temp_item.y = 150 + data[i].cy*0.75 * (height - 200) + (-0.5* (num_short_item - 1) + j )*temp_item.size *1.2;
					modified_data.push(temp_item);
			}
	}
	return [modified_data, num_documents];
	};

//shorten
function shorten( sent, count)  {
	var words = sent.split(" ");
	var words_count = parseInt(words.length * count / 50);
	if ( words_count > 5) {
			words_count = 5;
	} else if (words_count < 2) {
			words_count = 2;
	}
	var keywords = []

	for ( var i = 0 ; i < words_count ; i++) {
			keywords.push(words[i]);
	}
	return keywords ;
};

function choose_bubbles(d){

	var cluster_id = d.id;
	var cluster_color_ = d3.select(this).style('fill');
	var cluster_color = cluster_color_.substring(3, cluster_color_.indexOf(')'));
	cluster_color = "rgba" + cluster_color + ', 0.30)'

	if (this.style.filter != "url(\"#grayscale\")") { //deselect the circle
		this.style.filter = "url(\"#grayscale\")";
		this.style.stroke = "none"
	} else {
		this.style.filter = "none";
		this.style.stroke = "grey";

	}
			 if (d.id == "0") {
				var checkBox = $('input[name="ids"][value="0"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "1") {
				var checkBox = $('input[name="ids"][value="1"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "2") {
				var checkBox = $('input[name="ids"][value="2"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "3") {
				var checkBox = $('input[name="ids"][value="3"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "4") {
				var checkBox = $('input[name="ids"][value="4"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "5") {
				var checkBox = $('input[name="ids"][value="5"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "6") {
				var checkBox = $('input[name="ids"][value="6"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "7") {
				var checkBox = $('input[name="ids"][value="7"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else if (d.id == "8") {
				var checkBox = $('input[name="ids"][value="8"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}else  {
				var checkBox = $('input[name="ids"][value="9"]');
				checkBox.prop("checked", !checkBox.prop("checked"));
			}
	}

 var active_id
 //var active_id_prev

 var tooltip = d3.select("body")
 .append("div")
	.style("background-color", "grey")
	.style("border-radius", "5px")
	.style("padding", "10px")
	.style("width","300px")
	.style("color", "white")
	.style("position", "absolute")
	.style("z-index", "10")
	.style("visibility", "hidden");

function VoiceEdges(cluster) {
		var width = 1.0*document.getElementById("cluster").offsetWidth;
		var height = document.getElementById("cluster").offsetHeight;
		var edges = {{edges|safe}};
			for (pair in edges) {
				if (edges[pair]["clusterID"] == cluster) {
					if (edges[pair]["distance"] == "Very Similar") {
						console.log("ver")
						//draw lines for the links
						var line = d3.select("svg")
							.append("line")
							.attr("id", cluster)
							.attr("stroke", "grey")
							.attr("stroke-width", 8)
							.attr("opacity", 0.25)
							.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.on("mouseover",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0)
								document.getElementById("heuristicTable").style.visibility= "hidden";
							})
							.transition()
							.duration(500)
							.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

						// get equidistant point to place text on edge
						var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
						var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

						var edgeLabel = d3.select("svg")
							.append("text")
							.attr("id","edgeLabel"+cluster)
							.attr('text-anchor', 'middle')
							.attr("x", midX)
							.attr("y", midY)
							.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
							.attr("fill", "DodgerBlue")
							.attr("font-size", 14)
							.text(edges[pair].distance)
							.on("mouseover",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0);
								document.getElementById("heuristicTable").style.visibility= "hidden";
							});
					}
					if (edges[pair]["distance"] == "Similar") {
						console.log("sim")
						//draw lines for the links
						var line = d3.select("svg")
							.append("line")
							.attr("id", cluster)
							.attr("stroke", "grey")
							.attr("stroke-width", 2)
							.attr("opacity", 0.15)
							.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.on("mouseover",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0)
								document.getElementById("heuristicTable").style.visibility= "hidden";
							})
							.transition()
							.duration(500)
							.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

						// get equidistant point to place text on edge
						var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
						var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

						var edgeLabel = d3.select("svg")
							.append("text")
							.attr("id","edgeLabel"+cluster)
							.attr('text-anchor', 'middle')
							.attr("x", midX)
							.attr("y", midY)
							.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
							.attr("fill", "DodgerBlue")
							.attr("font-size", 12)
							.text(edges[pair].distance)
							.on("mouseover",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0);
								document.getElementById("heuristicTable").style.visibility= "hidden";
							});
					}

					if (edges[pair]["distance"] == "Distant") {
						console.log("dis")
						//draw lines for the links
						var line = d3.select("svg")
							.append("line")
							.attr("id", cluster)
							.attr("stroke", "grey")
							.attr("stroke-width", 2)
							.attr("stroke-dasharray", "10,10")
							.attr("opacity", 0.10)
							.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
							.on("mouseover",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#edgeLabel"+$(cluster).attr("id")+"-"+cluster).transition().attr("opacity",0);
								document.getElementById("heuristicTable").style.visibility= "hidden";
							})
							.transition()
							.duration(500)
							.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
							.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

						// get equidistant point to place text on edge
						var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
						var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

						var edgeLabel = d3.select("svg")
							.append("text")
							.attr("id","edgeLabel"+cluster)
							.attr('text-anchor', 'middle')
							.attr("x", midX)
							.attr("y", midY)
							.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
							.attr("fill", "DodgerBlue")
							.attr("font-size", 10)
							.text(edges[pair].distance)
							.on("mouseover",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0.75);
								document.getElementById("heuristicTable").style.visibility= "visible";
							})
							.on("mouseout",function(){
								d3.selectAll("#"+cluster).transition().attr("opacity",0);
								document.getElementById("heuristicTable").style.visibility= "hidden";
							});
					}
				}
			}
		}

function VoiceEdgesRemove(d) {
		// remove network edges
		d3.selectAll("line").remove()
		d3.selectAll("#edgeLabel").remove()
	}

	function showEdges(d){ //with edges
			//console.log("current id is " + d.id)
			//console.log(d)
			var width = 1.0*document.getElementById("cluster").offsetWidth;
			var height = document.getElementById("cluster").offsetHeight;
			//var id = d.id;
			//console.log(id);
			var edges = d.edges;
		 //console.log(d)

			//check if the lines have been drawn for the current cluster
			var overlappingLines = 0;
			d3.selectAll("line").each(function(){
				//console.log(this)
				//console.log($(this).attr("class"))
				if ($(this).attr("class") == d.id){
					overlappingLines += 1;
				}
			})
		 //console.log("edges are: " + edges)
			var lineId = 0;

				for (pair in edges) {
					//console.log(overlappingLines);

					if (edges[pair]["clusterID"] == d.id && overlappingLines == 0) {
						if (edges[pair]["distance"] == "Very Similar") {
						 //console.log("ver")
							//draw lines for the links
							var line = d3.select("svg")
								.append("line")
								.attr("class", d.id)
								.attr("id", lineId)
								.attr("stroke", "grey")
								.attr("stroke-width", 8)
								.attr("opacity", 0.25)
								.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.on("mouseover",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0)
									document.getElementById("heuristicTable").style.visibility= "hidden";
								})
								.transition()
								.duration(500)
								.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

							// get equidistant point to place text on edge
							var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
							var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

							var edgeLabel = d3.select("svg")
								.append("text")
								.attr("class", "edgeLabel"+d.id)
								.attr("id","edgeLabel"+d.id+"-"+lineId)
								.attr('text-anchor', 'middle')
								.attr("x", midX)
								.attr("y", midY)
								.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
								.attr("fill", "DodgerBlue")
								.attr("font-size", 14)
								.text(edges[pair].distance)
								.on("mouseover",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0);
									document.getElementById("heuristicTable").style.visibility= "hidden";
								});
						}
						if (edges[pair]["distance"] == "Similar") {
						 //console.log("sim")
							//draw lines for the links
							var line = d3.select("svg")
								.append("line")
								.attr("class", d.id)
								.attr("id", lineId)
								.attr("stroke", "grey")
								.attr("stroke-width", 2)
								.attr("opacity", 0.15)
								.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.on("mouseover",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0)
									document.getElementById("heuristicTable").style.visibility= "hidden";
								})
								.transition()
								.duration(500)
								.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

							// get equidistant point to place text on edge
							var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
							var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

							var edgeLabel = d3.select("svg")
								.append("text")
								.attr("class", "edgeLabel"+d.id)
								.attr("id","edgeLabel"+d.id+"-"+lineId)
								.attr('text-anchor', 'middle')
								.attr("x", midX)
								.attr("y", midY)
								.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
								.attr("fill", "DodgerBlue")
								.attr("font-size", 12)
								.text(edges[pair].distance)
								.on("mouseover",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0);
									document.getElementById("heuristicTable").style.visibility= "hidden";
								});
						}

						if (edges[pair]["distance"] == "Distant") {
						 //console.log("dis")
							//draw lines for the links
							var line = d3.select("svg")
								.append("line")
								.attr("class", d.id)
								.attr("id", lineId)
								.attr("stroke", "grey")
								.attr("stroke-width", 2)
								.attr("stroke-dasharray", "10,10")
								.attr("opacity", 0.10)
								.attr("x1", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y1", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.attr("x2", (200 + edges[pair].source[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].source[1] * 0.75 *(height-200)))
								.on("mouseover",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#edgeLabel"+$(this).attr("class")+"-"+this.id).transition().attr("opacity",0)
									document.getElementById("heuristicTable").style.visibility= "hidden";
								})
								.transition()
								.duration(500)
								.attr("x2", (200 + edges[pair].target[0] * 0.75 *(width-200)))
								.attr("y2", (150 + edges[pair].target[1] * 0.75 *(height-200)));

							// get equidistant point to place text on edge
							var midX = (200 + edges[pair].source[0] * 0.75 *(width-200)) + ((200 + edges[pair].target[0] * 0.75 *(width-200)) - (200 + edges[pair].source[0] * 0.75 *(width-200))) * 0.50;
							var midY= (150 + edges[pair].source[1] * 0.75 *(height-200)) + ((150 + edges[pair].target[1] * 0.75 *(height-200)) - (150 + edges[pair].source[1] * 0.75 *(height-200))) * 0.50;

							var edgeLabel = d3.select("svg")
								.append("text")
								.attr("class", "edgeLabel"+d.id)
								.attr("id","edgeLabel"+d.id+"-"+lineId)
								.attr('text-anchor', 'middle')
								.attr("x", midX)
								.attr("y", midY)
								.attr("opacity", 0)//.transition().duration(250).attr("opacity", 0.75)
								.attr("fill", "DodgerBlue")
								.attr("font-size", 10)
								.text(edges[pair].distance)
								.on("mouseover",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0.75);
									document.getElementById("heuristicTable").style.visibility= "visible";
								})
								.on("mouseout",function(){
									d3.selectAll("#"+this.id).transition().attr("opacity",0);
									document.getElementById("heuristicTable").style.visibility= "hidden";
								});
						}

					lineId += 1;
				}
			}
	}

	function mouseover(d){

		var width = 1.0*document.getElementById("cluster").offsetWidth;
		var height = document.getElementById("cluster").offsetHeight;

		if (d.id == undefined){
			id = this.id.slice(-1)
			var type = "tab";
		} else {
			id = d.id;
			var type = "circle";
		}
		d3.selectAll('circle').each(function(d){
			if (d.id == id){
			var cx = Number($(this).attr('cx'));
			var cy = Number($(this).attr('cy'));
			var r = Number($(this).attr('r'));
			d3.select('svg')
				.append('rect')
				.attr('class', 'contextMenu_tooltip_rect')
				.attr('id', 'contextMenu_tooltip')
				.attr('x', cx+r/2-2)
				.attr('y', cy+2*r/3-11)
				.style('height','25')
				.style('width','80')
				.style('fill','lightgrey')
				.style('opacity','50%');
			d3.select('svg')
				.append('text')
				.text('Right click for')
				.attr('class', 'contextMenu_tooltip_text')
				.attr('id', 'contextMenu_tooltip')
				.attr('x', cx+r/2)
				.attr('y', cy+2*r/3)
				.style('font-size','12px')
				.style('fill','dodgerblue');
			d3.select('svg')
				.append('text')
				.text('more options')
				.attr('class', 'contextMenu_tooltip_text')
				.attr('id', 'contextMenu_tooltip')
				.attr('x', cx+r/2)
				.attr('y', cy+2*r/3+11)
				.style('font-size','12px')
				.style('fill','dodgerblue');
		 }
		 // else{
			//  this.style.stroke = "none";
		 // }
	 });
	}

	function showDocuments(d){

		 var bibs_list = '';
		 var bibs_length = d.members.length;
		 //console.log("bibs="+bibs_length);
		 for (var j=0; j<bibs_length; j++){
			 if(d.bibs[j].title == undefined){
				 //console.log("titles are undefined")
				 var ind = j+1;
				 bibs_list = '';
			 }else if (d.bibs[j].html == undefined){
				 //console.log("html is undefined")
				 var ind = j+1;
				 var pmid = d.bibs[j].pmid;
				 body_toshow = d.bibs[j].body_toshow;
				 if (pmid == undefined){
					 if (body_toshow != undefined){
						 //console.log("body_toshow is not undefined")
						 body_toshow = body_toshow.replace(/'/g, '_singlequote_');
						 body_toshow = body_toshow.replace(/"/g, '_doublequote_');
						 body_toshow = body_toshow.replace(/\n/g, ' _startinganewline_ ');
						 bibs_list = bibs_list + '<br>' + '<a href=# class = "text_link" id="text_link'+ind+'" onclick="show_uploaded_articles(\''+ body_toshow + '\',\'text_link'+ind+'\')" >' + d.bibs[j].title + '</a> <br>';
					 }else{
						 bibs_list = bibs_list + '<br>' + '<a href =' + '"https://www.ncbi.nlm.nih.gov/pubmed/?term=' + d.bibs[j].title + '%5Buid%5D" onclick="return !window.open(this.href, \'somesite\', \'width=1000,height=700\')"target="_blank" >' + d.bibs[j].title + '</a> <br>'+ d.bibs[j].author + '<br>'+ d.bibs[j].journal + '<br>'+ d.bibs[j].pdate + '<br>' + '</br>';
					 }
				 }else{
					 bibs_list = bibs_list + '<br>' + '<a href =' + '"https://www.ncbi.nlm.nih.gov/pubmed/?term=' + pmid + '%5Buid%5D" onclick="return !window.open(this.href, \'somesite\', \'width=1000,height=700\')"target="_blank" >' + d.bibs[j].title + '</a> <br>'+ d.bibs[j].author + '<br>'+ d.bibs[j].journal + '<br>'+ d.bibs[j].pdate + '<br>' + '</br>';
				 }
			 }else{
				 //console.log("nothing is undefined")
				 bibs_list = bibs_list + '<br>' + '<a href ="' + d.bibs[j].html + '" onclick="return !window.open(this.href, \'somesite\', \'width=1000,height=700\')"target="_blank">' + d.bibs[j].title + '</a> <br>'
				 for (var element in d.bibs[j]){
					 //console.log("element is " + element + d.bibs[j][element])
					 if (element != 'title' & element != 'html' & d.bibs[j][element] != undefined){
						 //console.log("element is " + d.bibs[j][element] )
						 bibs_list = bibs_list + d.bibs[j][element] + '<br>'
					 }
				 }
				// bibs_list = bibs_list + '</br>'
				 //if(author == undefined){
					 //bibs_list = bibs_list + '<br>' + '<a href ="' + d.bibs[j].html + '" onclick="return !window.open(this.href, \'somesite\', \'width=1000,height=700\')"target="_blank">' + d.bibs[j].title + '</a> <br>' + d.bibs[j].author + '<br>'+ d.bibs[j].journal + '<br>' + '</br>';
				 //}else{
					 //var ind = j+1
					 //bibs_list = bibs_list + '<br>' + '<a href ="' + d.bibs[j].html + '" onclick="return !window.open(this.href, \'somesite\', \'width=1000,height=700\')"target="_blank">' + d.bibs[j].title + '</a> <br>' + d.bibs[j].author + '<br>'+ d.bibs[j].journal + '<br>' + '</br>';
				 //}
			 }
		 }
		 //documents
		 var container = document.getElementById("documentContainer")
		 container.innerHTML = '<h3 style="color:DodgerBlue;opacity:0.75">Clustered Publications</h3>' +
																		'\n<p>'+bibs_list+'</p>';
		}

		function mouseout(d){

			//decide the id of current object (tab or circle)
			if (d.id == undefined){
				id = this.id.slice(-1)
			} else {
				id = d.id;
			}
			//  d3.selectAll('circle').each(function(d){
			// if (d.id == id){
			// 	this.style.stroke = "none"}
			// });
		d3.selectAll(".contextMenu_tooltip_rect").remove();
		d3.selectAll(".contextMenu_tooltip_text").remove();
		}


	function hideEdges(d){

		//disable tooltip
		//tooltip.style("visibility", "hidden")

		//decide the id of current object (tab or circle)
		if (d.id == undefined){
			id = this.id.slice(-1)
		} else {
			id = d.id;
		}

		d3.selectAll('circle').each(function(d){

				//if the current circle is not selected, delete the content from panel and cancel the boarder
				if (d.id == id){

					var cluster_id = d.id;

					d3.selectAll('line').each(function(){ //check all lines
						if ($(this).attr("class") == cluster_id){ //if the id of the line is equal to the id of the circle
							// remove network edges
							this.remove();
							//d3.selectAll("#edgeLabel").remove()
						}
					})

					d3.selectAll("."+"edgeLabel"+cluster_id).remove();
				}
		});
	}

	// The table generation function
	function tabulate(data, columns) {
			 var table = d3.select("body").append("table")
							 .attr("id","heuristicTable")
							 .attr("style", "margin-top:45%; z-index:99; position: absolute")
							 .style("visibility","hidden")
							 .style("border-collapse", "collapse")// <= Add this line in
							 .style("border", "2px DodgerBlue solid"), // <= Add this line in
					 thead = table.append("thead"),
					 tbody = table.append("tbody");

			 // append the header row
			 thead.append("tr")
					 .selectAll("th")
					 .data(columns)
					 .enter()
					 .append("th")
					 .attr("style", "font-family: Courier; color: DodgerBlue; font-size: 11") // sets the font style
					 .text(function(column) { return column; });

			 // create a row for each object in the data
			 var rows = tbody.selectAll("tr")
					 .data(data)
					 .enter()
					 .append("tr");

			 // create a cell in each row for each column
			 var cells = rows.selectAll("td")
					 .data(function(row) {
							 return columns.map(function(column) {
									 return {column: column, value: row[column]};
							 });
					 })
					 .enter()
					 .append("td")
					 .attr("style", "font-family: Courier; color: DodgerBlue; font-size: 11") // sets the font style
					 .html(function(d) { return d.value; });

			 return table;
	 }

	//var width = 1.0*document.getElementById("cluster").offsetWidth;
	//var height = document.getElementById("cluster").offsetHeight;

	function contextMenu() {
			 var height = 20,
					 width = 110,
					 margin = 0.1, // fraction of width
					 items = [],
					 rescale = false;

	 function menu(x, y, circleId) {
					 d3.select('.context-menu').remove();
					 d3.select('foreignObject').remove();
				 //  scaleItems();

					 // Draw the menu
					 d3.select('svg')
							 .append('g').attr('class', 'context-menu')
							 .selectAll('tmp')
							 .data(items).enter()
							 .append('g').attr('class', 'menu-entry')
							 .attr('style','cursor: pointer')
							 .on('mouseover', function(){
									 d3.select(this).select('rect').attr('style', 'fill: rgb(200,200,200)') })
							 .on('mouseout', function(){
									 d3.select(this).select('rect').attr('style', 'fill: rgb(244,244,244); stroke: white; stroke-width: 1px') })
							 .on('click', function(d, i){
								 if (i == 0){
									 var text_id = "menu-text" + i.toString();
									 //console.log(text_id)
									 var menu_text = document.getElementById(text_id).textContent;
									 //console.log("menu_text is:")
									 //console.log(menu_text)
									 if (menu_text == 'Show Documents'){
									 d3.selectAll('circle').each(function(d){
										 if (d.id == circleId){
											 var foreign = d3.select('svg').append("foreignObject")
													.attr("id", "contextMenu_documents")
													.attr("class", "contextMenu_documents")
													.attr("x", function(){
														var svgWidth = document.getElementById("cluster").offsetWidth;
														if(x+110+300 > svgWidth){
															return x-301;
														}else{
															return x+110;
														}
													})
													.attr("y", function(d, i){
														var svgHeight = document.getElementById("cluster").offsetHeight;
														if((y + (i * height) + 400) > svgHeight){
															var diff = (y + (i * height) + 400) - svgHeight;
															return y + (i * height) - diff;
														}else{
															return (y + (i * height));
														}
													})
													.attr("width", 300)
													.attr("height", 400)
													.style("background-color", "rgb(244,244,244)")
													.style("border", "solid")
													.style("border-color", "lightgrey")
													.style("padding", "5px")
													.style("font-size", "13px")
													.style("text-align", "left")
													.append("xhtml:div")
													.attr("id", "documentContainer")
													.attr("class", "documentContainer")
													.style("max-height", "400px")
													.style("overflow-y", "scroll");

											 /*var innerSvg = foreign.append("svg")
													.attr("id", "documentSvg")
													.attr("class", "documentSvg")
													.attr("width", 300)
													.attr("height", 1000)
													.style("background-color", "lightgrey")
													.style("opacity", "50%");
											 */
											 document.getElementById(text_id).textContent = 'Hide Documents';
											 showDocuments(d);
										 }

									 })
								 }else{
									 document.getElementById(text_id).textContent = 'Show Documents';
									 d3.select('foreignObject').remove();
								 }
								 }else if(i == 1){
										var text_id = "menu-text" + i.toString();
										//console.log(text_id)
										var menu_text = document.getElementById(text_id).textContent;
										//console.log("menu_text is:")
										//console.log(menu_text)
										if (menu_text == 'Show Edges'){
											document.getElementById(text_id).textContent = 'Hide Edges';
											d3.selectAll('circle').each(function(d){
												if (d.id == circleId){
													showEdges(d);
												}
											})
										}else{
											document.getElementById(text_id).textContent = 'Show Edges';
											hideEdges(d);
										}
								 }else if(i == 2){
									 d3.selectAll('line').remove();
									 for (i=0; i<10; i++){
										 d3.selectAll('.edgeLabel'+i.toString()).remove();
									 }
									 document.getElementById("menu-text1").textContent = 'Show Edges';
								 }else if(i == 3){
									 var text_id = "menu-text" + i.toString();
									 var menu_text = document.getElementById(text_id).textContent;
									 if(menu_text == "Zoom in"){
										 document.getElementById('calculate').click();
									 }else if(menu_text == "Zoom out"){
										 document.getElementById('back').click();
									 }else{
										 d3.select('.context-menu').remove();
										 d3.select('foreignObject').remove();
									 }
								 }else if (i == 4){
									 var text_id = "menu-text" + i.toString();
									 var menu_text = document.getElementById(text_id).textContent;
									 if(menu_text == "Zoom in"){
										 document.getElementById('calculate').click();
									 }else if(menu_text == "Zoom out"){
										 document.getElementById('back').click();
									 }else{
										 d3.select('.context-menu').remove();
										 d3.select('foreignObject').remove();
									 }
								 }else if (i == 5){
									 d3.select('.context-menu').remove();
									 d3.select('foreignObject').remove();
								 }
								 });

					 d3.selectAll('.menu-entry')
							 .append('rect')
							 .attr('id', function(d, i){return 'menu-rect' + i.toString()})
							 .attr('class','menu-rect')
							 .attr('x', x)
							 .attr('y', function(d, i){ return (y + (i * height)); })
							 .attr('width', width)
							 .attr('height', height)
							 .attr('style','fill: rgb(244,244,244); stroke: white; stroke-width: 3px; padding:1px;');


					 d3.selectAll('.menu-entry')
							 .append('text')
							 .attr('id', function(d, i){return 'menu-text' + i.toString()})
							 .attr('class','menu-text')
							 .text(function(d){ return d; })
							 .attr('x', x)
							 .attr('y', function(d, i){ return (y + (i * height) - 3 ); })
							 .attr('dy', height - margin / 2 - 2)
							 .attr('dx', margin)
							 .attr('style', 'fill: dodgerblue; font-size: 13');

						//Other interactions
					 d3.select('#background_rect')
							 .on('click', function() {
									d3.select('.context-menu').remove();
									d3.select('foreignObject').remove();
							 });

			 }


				 menu.items = function(e) {
						 if (!arguments.length) return items;
						 for (i in arguments) items.push(arguments[i]);
						 rescale = true;
						 return menu;
				 }





			 return menu;
	 }





</script>

<script type=text/javascript charset="utf-8">
	$SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
</script>

<!--style for bubble chart-->
<style>
	#tabs .ui-state-active {
		background: #45a049 !important;
		border: 0px solid #fff;
	}

		circle {
			stroke-width: 3px;
		}

</style>

<script type=text/javascript charset="utf-8">
 window.onload = function() {
 // declare global variable
 var width = 1.0*document.getElementById("cluster").offsetWidth;
 var height = document.getElementById("cluster").offsetHeight;
//console.log(width)

	$(function() {
		<!-- bydate -->
		$('a#bydate').bind('click', function() {
			console.log("dataset: " + dataset)
			var list_bydate = []
			var latest_year = ''
			var oldest_year = ''
			var object_bydate = {};
			var all_ranges = []
			//console.log(dataset)
			//grabing all data
			d3.selectAll('circle').each(function(d){
				//console.log("circle data is: ")
				//console.log(d)
				//console.log(d.bibs)
				for (bib_ind in d.bibs){
					//console.log(d.bibs[bib_ind])
					//find out the date range; assume the list is not ranked by date
					var date = d.bibs[bib_ind].pdate
					if (latest_year == '' || latest_year < date.substring(0,4)){
						latest_year = date.substring(0,4)
					}
					if (oldest_year == '' || oldest_year > date.substring(0,4)){
						oldest_year = date.substring(0,4)
					}
					list_bydate.push(d.bibs[bib_ind])
				}
			});
				console.log("latest_year is:")
				console.log(latest_year)
				console.log("oldest_year is:")
				console.log(oldest_year)
				var date_range = Number(latest_year) - Number(oldest_year);
				//set the number of intervals.
				if (date_range == 0){ //if there are one year presents, do monthly
					var number_of_intervals = 12
					var current_year = latest_year
					for (var i = 1; i <= number_of_intervals; i++){ //getting all date intervals
						if (i<10){
							var current_month = '0'+ i.toString()
						} else {
							var current_month = i.toString()
						}
						var current_range_str = current_year + '-' + current_month
						console.log("current_range_str: " + current_range_str)
						object_bydate[current_range_str]=[]
						all_ranges.push(i)
					}

					for (var i in list_bydate){
						console.log(list_bydate[i])
						var date = list_bydate[i].pdate
						var doc_month = date.substring(0,7)
						console.log("doc_month: " + doc_month)
						object_bydate[doc_month].push(list_bydate[i])
					}

				} else if (date_range > 10){ //if there are more than 10 years present, count the years older than 10 years together.
					var number_of_intervals = 11
					var current_year = latest_year
					var final_range = ''
					for (var i = 0; i < number_of_intervals; i++){ //getting all date intervals
						if(i != 10){
							var current_range_str = current_year - i
						} else {
							var current_range_str = oldest_year + '-' + (current_year - i)
							final_range = current_range_str
						}
						console.log("current_range_str: " + current_range_str)
						object_bydate[current_range_str]=[]
						all_ranges.push()
					}

					for (var i in list_bydate){
						console.log(list_bydate[i])
						var date = list_bydate[i].pdate
						var doc_year = date.substring(0,4)
						console.log("doc_year: " + doc_year)
						if (object_bydate[doc_year]) {
							object_bydate[doc_year].push(list_bydate[i])
						} else {
							object_bydate[final_range].push(list_bydate[i])
						}

					}

				} else { //if there are more than one year but less than 10 years present, do yearly.
					var number_of_intervals = date_range + 1;
					var current_year = latest_year
					for (var i = 0; i < number_of_intervals; i++){ //getting all date intervals
						var current_range_str = current_year - i
					}
						console.log("current_range_str: " + current_range_str)
						object_bydate[current_range_str]=[]
						all_ranges.push()
					}

					for (var i in list_bydate){
						console.log(list_bydate[i])
						var date = list_bydate[i].pdate
						var doc_year = date.substring(0,4)
						console.log("doc_year: " + doc_year)
					}

				console.log("number_of_intervals")
				console.log(number_of_intervals)
				console.log(object_bydate)
			//console.log(all_ranges)
	})
});

	$(function() {
		<!-- reclustering -->
		$('a#calculate').bind('click', function() {
			//console.log("reclustering width: " + width)
			d3.select('.context-menu').remove();
			d3.select('foreignObject').remove();
			//reclustering the documents in selected bubbles
			var check = 0;
			d3.selectAll("circle").each(function(){
						if (this.style.filter != "url(\"#grayscale\")") {
							check += 1;
							//remove all the tabs for documents
							var cluster_id = this.id;
						}
						});
		if (check > 0){
			$('input[name="ids"]').prop('checked', false);

			var all_texts = d3.selectAll("text");
			var all_circles = d3.selectAll("circle");
			//  .attr("fill",red);
			var all_circles_data = d3.selectAll("circle").data();
			//console.log("cir_data="+all_circles_data )
			var ids = [] ;
			var arrayLength = all_circles["_groups"][0].length;

			for ( var i = 0 ; i <arrayLength ; i++) {

				 if (all_circles["_groups"][0][i].style.filter != "url(\"#grayscale\")") {
					//if (all_circles["_groups"][0][i].style.filter =="url('#f1')" ){
					 //console.log( all_circles.data()[i].item.id.toString()+ " is selected.")
					 ids.push(all_circles_data[i].id)
					//animation of gathering
					//choosing circle by its id
					//moving the texts with circle when the distance between their coordiniation and the circle center are less than r
					var this_circle = all_circles["_groups"][0][i]
					var circle_x = this_circle.getAttribute("cx")
					var circle_y = this_circle.getAttribute("cy")
					var circle_r = this_circle.getAttribute("r")
					var circle_id = this_circle.getAttribute("id")
					var selected_circle = d3.select(this_circle);
					selected_circle
						.transition()
						.attr("cx",600)
						.attr("cy",300)
						// .delay()
						.duration(500);
					d3.selectAll("text").each(function(){
						var text_id = this.getAttribute("id");
						var text_x = this.getAttribute("x");
						var text_y = this.getAttribute("y");
						//console.log(text_x)
						//console.log(text_y)
						//console.log(circle_x)
						//console.log(circle_y)
						if (text_id == circle_id){
							var selected_text = d3.select(this);
							selected_text
								.transition()
								.attr("x",600)
								.attr("y",300 + (text_y-circle_y))
								// .delay()
								.duration(500);
								}
							});
						//}
						 }else{
							var this_circle = all_circles["_groups"][0][i];
							var selected_circle = d3.select(this_circle);
							var circle_id = this_circle.getAttribute("id")
							selected_circle.remove();
							d3.selectAll("text").each(function(){
								var text_id = this.getAttribute("id");
								//console.log(text_x)
								//console.log(text_y)
								//console.log(circle_x)
								//console.log(circle_y)
								if (text_id == circle_id){
									var selected_text = d3.select(this);
									selected_text
										.remove()
										}
									});
						}
//    		 if (all_circles[i].style.stroke == "gray") {
//    			alert( all_circles[i].item.id.toString()+ " is selected.")
				}
				count_documents = 0
				for (var i = 0; i < ids.length; i++) {
						count_documents += all_circles_data[ids[i]].count
				}
				if (count_documents < 10) {
					alert('Wait a second! \n\nReview your currently selected cluster(s) or collect more to use the "Zoom In" feature.')
					$.getJSON($SCRIPT_ROOT + '/_back', { }, function(data) {
						var new_data = [] ;
						data_length = data.cls.desc.length ;

						for (var i = 0 ; i < data_length ; i++ ) {
						temp_obj = {};
						keywords = "";
						word_length = data.cls.desc[i].length ;

						//formatting the data
						for (var j = 0 ; j < word_length ; j++) {
							if (j == 0) {
								keywords = data.cls.desc[i][j];
							} else {
								keywords = keywords + " " + data.cls.desc[i][j];
							}
						}
						temp_obj["keywords"]= keywords;
						temp_obj["edges"] = data.cls.edges;
						temp_obj["count"] = data.cls.id2freq[i];
						temp_obj["id"] = i.toString();
						temp_obj["cx"] = data.cls.xy[i][0];
						temp_obj["cy"] = data.cls.xy[i][1];
						temp_obj["hue"] = data.cls.hue[i];
						temp_obj["satr"] = data.cls.satr[i];
						temp_obj["val"] = data.cls.val[i];
						temp_obj["response_time"] = data.cls.response_time[i];
						var members = data.cls.id2members[i];
						temp_obj["members"] = members;
						// temp_obj["chosen"] = data.cls.chosen[i];
						//console.log("id2members="+members);
						var bibs_ = {};
						for (var j = 0; j < members.length; j++){
							var member = members[j];
							//console.log(data.cls.bibs[member].title);
							bibs_[j]={};
							bibs_[j]["title"] = data.cls.bibs[member].title;
							bibs_[j]["body_toshow"] = data.cls.bibs[member].body_toshow;
							bibs_[j]["author"] = data.cls.bibs[member].author;
							bibs_[j]["journal"] = data.cls.bibs[member].journal;
							bibs_[j]["pdate"] = data.cls.bibs[member].pdate;
							bibs_[j]["pmid"] = data.cls.bibs[member].pmid;
							bibs_[j]["html"] = data.cls.bibs[member].html;
						}
						//console.log("bibs_="+bibs_)
						temp_obj["bibs"] = bibs_;
						new_data.push(temp_obj);
					}

					//remove the old svg
					d3.select("svg").remove();

					//add heutistic table
								var heuristicTable = tabulate([{'Distance':'Very Similar','Meaning':'More than or equal to 75% semantic similarity'}, {'Distance':'Similar','Meaning':'Between 50% and 75% semantic similarity'},{'Distance':'Distant', 'Meaning':'Less than 50% semantic similarity'}], ["Distance", "Meaning"]);

								heuristicTable.selectAll("tbody tr")
											.sort(function(a, b) {
															return d3.descending(a.close, b.close);
											});

								heuristicTable.selectAll("thead th")
											.text(function(column) {
															return column.charAt(0).toUpperCase()+column.substr(1);
											});


					//new svg
					var svg = d3.select(".bubbleChart").append("svg").attr("width",width)
									.attr("height",height)

					var rect = d3.select('svg').append("rect")
					 .attr("id","background_rect")
					 .attr("fill","white")
					 .attr("height",height)
					 .attr("width", width);

					 var dataset =  new_data;

					 var node = svg.selectAll(".node")
						.data(dataset)
						.enter();
						
					var modified_dataset = modify_data(dataset, width, height);
					//console.log(modified_dataset);

					 var texts = svg.selectAll("text")
						.data(modified_dataset[0])
						.enter()
						.append("text");
						
					 //textualize
					 function textualize (d) {

						 var selection = d3.select(this);
						 selection.text(function (d) {
								 return d.keyword;
						 })
						 .attr("id", function(d){return(d.id)})
						 .style('-webkit-user-select', 'none')
						.style('-khtml-user-select', 'none')
						.style('-moz-user-select', 'none')
						.style('-ms-user-select', 'none')
						.style('-o-user-select', 'none')
						.style('user-select', 'none')
						 .attr("font-family", "sans-serif")
						 .attr("font-size", function (d) {
								 return d.size * 1.5
						 })
						 .attr("fill", "grey")
						 .attr("text-anchor", "middle")
						 .attr("text-transform", "capitalize")
						 .attr("x",600)
						 .attr("y",function(d){
								 return (d.y-300)/600*100+300;
						 })
						 .on('mouseover', mouseover)
						 //.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
						 .on('mouseout', mouseout)
						 .transition()
						 .attr("x", function (d) {
								 return d.x;
						 })
						 .attr("y", function (d) {
								 return d.y;
						 })
						 .duration(500);
						 };


						//Add SVG Text Element Attributes
						var textLabels = texts.each(textualize, d);

					 var g = node
						.append("g");

					 //making the new circles
						var circle = g.append("circle")
							.attr("id", function(d){return(d.id)})
							//.attr("pulse",false)
							.attr("fill", function(d){
								return (d3.hsl(d.hue, d.satr, d.val ));
							 })
							.attr("style",'filter:url(\"#grayscale\")')
							.attr("cx", 600)
							.attr("cy", 300)
							.attr("r", function(d) { return Math.sqrt(d.count/(modified_dataset[1]*1.2))*270; })
							.attr("fill-opacity","0.20")
							.on('mouseover', mouseover)
							//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
							.on('mouseout', mouseout)
							.on('contextmenu', function(d){
								var selected_bibs = 0
								d3.selectAll('circle').each(function(d){
									var bibs_length = 0;
									if(this.style.filter != "url(\"#grayscale\")"){
										var bibs_length = d.members.length;
									}
									selected_bibs += bibs_length;
								})
								//console.log("selected_bibs:")
								//console.log(selected_bibs)
								if(selected_bibs>=10){
									var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom in', 'Zoom out', 'Close Menu');
								}else{
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom out', 'Close Menu');
								}
									d3.event.preventDefault();
									menu(d3.mouse(this)[0], d3.mouse(this)[1], d.id);
							})
							.transition()
							.attr("cx", function(d) { return (200 + d.cx * 0.75 *(width-200)); })
							.attr("cy", function(d) { return (150 + d.cy * 0.75 *(height-200)); })
							.duration(500);

					var zoom = d3.zoom()
						.scaleExtent([1, 10])
						.on("zoom", function(){
							var e = d3.event;
							tx = Math.min(0, Math.max(e.transform.x, width - width * e.transform.k)),
							ty = Math.min(0, Math.max(e.transform.y, height - height * e.transform.k));
							g.attr('transform', [
									"translate(" + [tx, ty] + ")",
									"scale(" + e.transform.k + ")"
						 ].join(" "));
							texts.attr('transform', [
									"translate(" + [tx, ty] + ")",
									"scale(" + e.transform.k + ")"
						 ].join(" "));
					 });

					//svg.call(zoom);

					d3.select(self.frameElement)
									.style("height", height + "px");

					var svg = d3.select("svg");
					var defs = svg.append("defs");

					var grayscalefilter = defs.append('svg:filter')
						.attr('id','grayscale');
					grayscalefilter.append('svg:feColorMatrix')
						.attr('type','matrix')
						.attr('values','0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0');

					d3.selectAll("text").on("click", function(d) {

						var text_id = d.id;

						d3.selectAll('circle[id="'+text_id+'"]').each(choose_bubbles,d);
						//$(floater)
					});//end of text click

						d3.selectAll("circle").on("click",choose_bubbles);
						//$(floater)
						//console.log(data)
						d3.selectAll("circle").each(function(d){
							if (d.chosen == 1){
								//console.log("choose this circle")
								d3.selectAll('circle[id="' + d.id + '"]').each(choose_bubbles,d);
							}

						})
					});
				}

			 //remove the edges
			d3.selectAll("line").remove();

			 setTimeout(function(){//delay the following code for 1000ms such that the animation can be finished
				 $.getJSON($SCRIPT_ROOT + '/_re_cluster_voice', {
					 ids: ids
				 }, function(data) {
					 //formatting the new data
					 var new_data = [] ;
						 data_length = data.cls.desc.length ;

						 for (var i = 0 ; i < data_length ; i++ ) {
							 temp_obj = {};
							 keywords = "";
							 word_length = data.cls.desc[i].length ;
							 for (var j = 0 ; j < word_length ; j++) {
								 if (j == 0) {
									 keywords = data.cls.desc[i][j];
								 } else {
									 keywords = keywords + " " + data.cls.desc[i][j];
								 }
							 }

							 temp_obj["keywords"]= keywords;
							 temp_obj["edges"] = data.cls.edges;
							 //console.log("keywords = "+keywords)
							 temp_obj["count"] = data.cls.id2freq[i];
							 temp_obj["id"] = i.toString();
							 //console.log(i + "and" + temp_obj["id"])
							 temp_obj["cx"] = data.cls.xy[i][0];
							 temp_obj["cy"] = data.cls.xy[i][1];
							 temp_obj["hue"] = data.cls.hue[i];
							 temp_obj["satr"] = data.cls.satr[i];
							 temp_obj["val"] = data.cls.val[i];
							 temp_obj["response_time"] = data.cls.response_time[i];
							 var members = data.cls.id2members[i];
							 temp_obj["members"] = members;
							 //console.log("id2members="+members);
							 var bibs_ = {};
							 for (var j = 0; j < members.length; j++){
								 var member = members[j];
								 //console.log(data.cls.bibs[member].title);
								 bibs_[j]={};
								 bibs_[j]["title"] = data.cls.bibs[member].title;
								 bibs_[j]["body_toshow"] = data.cls.bibs[member].body_toshow;
								 bibs_[j]["author"] = data.cls.bibs[member].author;
								 bibs_[j]["journal"] = data.cls.bibs[member].journal;
								 bibs_[j]["pdate"] = data.cls.bibs[member].pdate;
								 bibs_[j]["pmid"] = data.cls.bibs[member].pmid;
								 bibs_[j]["html"] = data.cls.bibs[member].html;
							 }
							 //console.log("bibs_="+bibs_)
							 temp_obj["bibs"] = bibs_;
							 new_data.push(temp_obj);
						 }

					//remove the old svg
					 d3.select("svg").remove();

					 //add heutistic table
					var heuristicTable = tabulate([{'Distance':'Very Similar','Meaning':'More than or equal to 75% semantic similarity'}, {'Distance':'Similar','Meaning':'Between 50% and 75% semantic similarity'},{'Distance':'Distant', 'Meaning':'Less than 50% semantic similarity'}], ["Distance", "Meaning"]);

					heuristicTable.selectAll("tbody tr")
								.sort(function(a, b) {
												return d3.descending(a.close, b.close);
								});

					heuristicTable.selectAll("thead th")
								.text(function(column) {
												return column.charAt(0).toUpperCase()+column.substr(1);
								});

					var svg = d3.select(".bubbleChart")
									.append("svg")
									.attr("width",width)
									.attr("height",height)

					var rect = d3.select('svg').append("rect")
								 .attr("id","background_rect")
								 .attr("fill","white")
								 .attr("height",height)
								 .attr("width", width);

					 var dataset =  new_data;

					 var node = svg.selectAll(".node")
						.data(dataset)
						.enter();
						
					var modified_dataset = modify_data(dataset, width, height);
					//console.log(modified_dataset);

					 var texts = svg.selectAll("text")
						.data(modified_dataset[0])
						.enter()
						.append("text");
						
					 //textualize
					 function textualize (d) {

						 var selection = d3.select(this);
						 selection.text(function (d) {
								 return d.keyword;
						 })
						 .attr("id", function(d){return(d.id)})
						 .style('-webkit-user-select', 'none')
						.style('-khtml-user-select', 'none')
						.style('-moz-user-select', 'none')
						.style('-ms-user-select', 'none')
						.style('-o-user-select', 'none')
						.style('user-select', 'none')
						 .attr("font-family", "sans-serif")
						 .attr("font-size", function (d) {
								 return d.size * 1.5
						 })
						 .attr("fill", "grey")
						 .attr("text-anchor", "middle")
						 .attr("text-transform", "capitalize")
						 .attr("x",600)
						 .attr("y",function(d){
								 return (d.y-300)/600*100+300;
						 })
						 .on('mouseover', mouseover)
						 //.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
						 .on('mouseout', mouseout)
						 .transition()
						 .attr("x", function (d) {
								 return d.x;
						 })
						 .attr("y", function (d) {
								 return d.y;
						 })
						 .duration(500);
						 };


						//Add SVG Text Element Attributes
						var textLabels = texts.each(textualize, d);

					 var g = node
						.append("g");

					 //making the new circles
						var circle = g.append("circle")
							.attr("id", function(d){return(d.id)})
							//.attr("pulse",false)
							.attr("fill", function(d){
								return (d3.hsl(d.hue, d.satr, d.val ));
							 })
							.attr("style",'filter:url(\"#grayscale\")')
							.attr("cx", 600)
							.attr("cy", 300)
							.attr("r", function(d) { return Math.sqrt(d.count/(modified_dataset[1]*1.2))*270; })
							.attr("fill-opacity","0.20")
							.on('mouseover', mouseover)
							//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
							.on('mouseout', mouseout)
							.on('contextmenu', function(d){
								var selected_bibs = 0
								d3.selectAll('circle').each(function(d){
									var bibs_length = 0;
									if(this.style.filter != "url(\"#grayscale\")"){
										var bibs_length = d.members.length;
									}
									selected_bibs += bibs_length;
								})
								//console.log("selected_bibs:")
								//console.log(selected_bibs)
								if(selected_bibs>=10){
									var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom in', 'Zoom out', 'Close Menu');
								}else{
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom out', 'Close Menu');
								}
									d3.event.preventDefault();
									menu(d3.mouse(this)[0], d3.mouse(this)[1], d.id);
							})
							.transition()
							.attr("cx", function(d) { return (200 + d.cx * 0.75 *(width-200)); })
							.attr("cy", function(d) { return (150 + d.cy * 0.75 *(height-200)); })
							.duration(500);

						//adding zoom feature
						var zoom = d3.zoom()
							// only scale up, e.g. between 1x and 50x
							.scaleExtent([1, 10])
							.on("zoom", function(){
								var e = d3.event;
								tx = Math.min(0, Math.max(e.transform.x, width - width * e.transform.k)),
								ty = Math.min(0, Math.max(e.transform.y, height - height * e.transform.k));
								g.attr('transform', [
										"translate(" + [tx, ty] + ")",
										"scale(" + e.transform.k + ")"
							 ].join(" "));
								texts.attr('transform', [
										"translate(" + [tx, ty] + ")",
										"scale(" + e.transform.k + ")"
							 ].join(" "));
							})
							//svg.call(zoom);

						d3.select(self.frameElement)
								.style("height", height + "px");

						var svg = d3.select("svg");
						var defs = svg.append("defs");

						var grayscalefilter = defs.append('svg:filter')
							.attr('id','grayscale');
						grayscalefilter.append('svg:feColorMatrix')
							.attr('type','matrix')
							.attr('values','0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0');


						d3.selectAll("text").on("click", function(d) {

							var text_id = d.id;

							d3.selectAll('circle[id="'+text_id+'"]').each(choose_bubbles,d);
							//$(floater)
						});//end of text click

							d3.selectAll("circle").on("click",choose_bubbles);


								 // get the cluster labels for concept navigation
								 var concepts = data.cls.desc;
								 // get the references for concept navigation
								 var sources = data.cls.sources;
								 // use this mapping to undo DOM text content changes (author-to-keyword map)
								 var keywordAuthorMap = {};
								 // count console transcript to prevent duplicate command executions
								 var count = (function() {
									 var counter = {};
									 return function(v) {
										 return (counter[v] = (counter[v] || 0) + 1);
									 }
							 }());
							// make transcript global and changeable
							// have PATTIE always listening
							recognition.continuous = true;
							// extract transcript object as query
							recognition.onresult = function(event) {
							// console.log(event)
							transcript = event.results[0][0].transcript.toLowerCase()
							if (transcript === 'search again') {
								// go back to main page to search again
								window.history.back()
								// don't execute anything until proper command is given
							} else {
									for (recording in event.results) {
										console.log(event.results[recording])
										var transcript = event.results[recording][0].transcript.toLowerCase().trim();
										console.log('Thought Transition Command: ' + transcript)

										if (transcript === ' search again') {
											window.history.back();
										}

										// // voice command for displaying/removing connections (edges)
										// else if (transcript.trim().trim().startsWith('similar')) {
										//   if (count(transcript) > 1) {
										//     console.log('Command ignored, already executed.');
										//     continue;
										//   } else {
										//     outline.push("Thought Transition Command: "+transcript)
										//     transcript = transcript.replace('similar', '')
										//     for (cluster in concepts) {
										//       // console.log(concepts[cluster])
										//       if (concepts[cluster].includes(transcript.trim().toLowerCase())) {
										//         console.log(transcript + ' is in cluster ' + cluster)
										//         VoiceEdges(cluster);
										//       }
										//     }
										//   }
										// }

										// remove network edges by voice
										else if (transcript.trim().trim().startsWith('remove')) {
											console.log('Command: ' + transcript)
											VoiceEdgesRemove(d);
										}


										// Thought Transition Command - "ontology [keyword]": baseURL: http://amigo.geneontology.org/amigo/search/ontology?q=[keyword]
										else if (transcript.trim().startsWith('ontology')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Ontology", "Intention":transcript.replace('ontology', '').trim()})
												transcript = transcript.replace('ontology', '')
												console.log('Retrieved gene ontology information for ' + transcript)
												ontology = window.open("http://amigo.geneontology.org/amigo/search/ontology?q="+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
												outline.push("Ontology Source: http://amigo.geneontology.org/amigo/search/ontology?q="+transcript.trim().toLowerCase())
											}
										}

										// Thought Transition Command - "evidence [keyword]" : baseURL: http://amigo.geneontology.org/amigo/search/annotation?q=[keyword]
										else if (transcript.trim().startsWith('evidence')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Evidence", "Intention":transcript.replace('evidence', '').trim()})
												transcript = transcript.replace('evidence', '')
												console.log('Retrieved gene annotation information for ' + transcript)
												window.open("http://amigo.geneontology.org/amigo/search/annotation?q="+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
												outline.push("Evidence Source: http://amigo.geneontology.org/amigo/search/annotation?q="+transcript.trim().toLowerCase())
											}
										}

										// source: https://www.genome.jp/kegg/pathway.html
										// Thought Transition Command - "pathway [keyword]''
										else if (transcript.trim().startsWith('disease pathway')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Disease Pathway", "Intention":transcript.replace('disease pathway', '').trim()})
												transcript = transcript.replace('disease pathway', '')
												console.log('Retrieved disease pathway information for ' + transcript)
												window.open("https://www.kegg.jp/kegg-bin/search_pathway_text?map=hsa&"+"keyword="+transcript.trim().toLowerCase()+"&mode=1&viewImage=true","_blank","width=1250,height=800");
												outline.push("Disease Pathway Source: https://www.kegg.jp/kegg-bin/search_pathway_text?map=hsa&"+"keyword="+transcript.trim().toLowerCase()+"&mode=1&viewImage=true")
											}
										}

										// Thought Transition Command - "protein pathway [keyword]''
										else if (transcript.trim().startsWith('protein pathway')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Protein Pathway", "Intention":transcript.replace('protein pathway', '').trim()})
												transcript = transcript.replace('protein pathway', '')
												window.open("https://reactome.org/content/query?q="+transcript.trim().toLowerCase()+"&species=Homo+sapiens&types=Protein&cluster=true","_blank","width=1250,height=800");
												console.log('Retrieved protein pathway information for ' + transcript)
												outline.push("Protein Pathway Source: https://reactome.org/content/query?q="+transcript.trim().toLowerCase()+"&species=Homo+sapiens&types=Protein&cluster=true")
											}
										}

										// Thought Transition Command - "drug [keyword]''
										else if (transcript.trim().startsWith('drug')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Drug", "Intention":transcript.replace('drug', '').trim()})
												transcript = transcript.replace('drug', '')
												window.open("https://www.drugbank.ca/unearth/q?utf8=✓&searcher=drug&query="+transcript.trim().toLowerCase()+"&approved=1&investigational=1&experimental=1&us=0&us=1&ca=0&eu=0&commit=Apply+Filter","_blank","width=1250,height=800");
												console.log('Retrieved drug information for ' + transcript)
												outline.push("Drug Source: https://www.drugbank.ca/unearth/q?utf8=✓&searcher=drug&query="+transcript.trim().toLowerCase()+"&approved=1&investigational=1&experimental=1&us=0&us=1&ca=0&eu=0&commit=Apply+Filter")
											}
										}



										// source: https://genemania.org/
										// Thought Transition Command - "network [keyword]"
										else if (transcript.trim().startsWith('network')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Network", "Intention":transcript.replace('network', '').trim()})
												transcript = transcript.replace('network', '')
												console.log('Retrieved gene network information for ' + transcript)
												window.open("https://genemania.org/search/homo-sapiens/"+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
												outline.push("Network Model Source: https://genemania.org/search/homo-sapiens/"+transcript.trim().toLowerCase())
											}
										}


										// source: clinicaltrials.gov
										// Thought Transition Command - "clinical trial [keyword]"
										else if (transcript.trim().startsWith('clinical trial')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Clinical Trial", "Intention":transcript.replace('clinical trial', '').trim()})
												transcript = transcript.toLowerCase().replace('clinical trial', '')
												console.log('Retrieved active clinical trials for condition ' + transcript)
												window.open("https://clinicaltrials.gov/ct2/results?cond="+transcript+"&Search=Apply&recrs=b&recrs=a&recrs=f&age_v=&gndr=&type=&rslt=","_blank","width=1250,height=800");
												outline.push("Clinical Trial Source: https://clinicaltrials.gov/ct2/results?cond="+transcript+"&Search=Apply&recrs=b&recrs=a&recrs=f&age_v=&gndr=&type=&rslt=")
											}
										}

										// source: Google
										// Thought Transition Command - "Google [keyword]"
										else if (transcript.trim().startsWith('google')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Google", "Intention":transcript.replace('google', '').trim()})
												transcript = transcript.toLowerCase().replace('google', '')
												console.log('Retrieved Google web search for ' + transcript)
												window.open("https://www.google.com/search?q="+transcript,"_blank","width=1250,height=800");
												outline.push("Google Result Source: https://www.google.com/search?q="+transcript)
											}
										}

										// source: YouTube
										// Thought Transition Command - "YouTube [keyword]"
										else if (transcript.trim().startsWith('youtube')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"YouTube", "Intention":transcript.replace('youtube', '').trim()})
												transcript = transcript.toLowerCase().replace('youtube', '')
												console.log('Retrieved YouTube search for ' + transcript)
												window.open("https://www.youtube.com/results?search_query="+transcript,"_blank","width=1250,height=800");
												outline.push("YouTube Result Source: https://www.youtube.com/results?search_query="+transcript)
											}
										}

										// source: https://grants.nih.gov/grants/oer.htm
										// Thought Transition Command - "grant [keyword]"
										else if (transcript.trim().startsWith('grant')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Grant", "Intention":transcript.replace('grant', '').trim()})
												transcript = transcript.toLowerCase().replace('grant', '')
												console.log('Retrieved YouTube search for ' + transcript)
												window.open("https://grants.nih.gov/funding/SearchGuide/index.html?query="+transcript+"&x=0&y=0#/","_blank","width=1250,height=800");
												outline.push("Grant Funding Source: https://grants.nih.gov/funding/SearchGuide/index.html?query="+transcript+"&x=0&y=0#/")
											}
										}

										// source: https://academic.microsoft.com/
										// Thought Transition Command - "authority [keyword]"
										else if (transcript.trim().startsWith('authority')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Authority", "Intention":transcript.replace('authority', '').trim()})
												transcript = transcript.toLowerCase().replace('authority', '')
												console.log('Retrieved authority information for ' + transcript)
												window.open("https://academic.microsoft.com/search?q="+transcript+"&f=&orderBy=0","_blank","width=1250,height=800");
												outline.push("Authority Source: https://academic.microsoft.com/search?q="+transcript+"&f=&orderBy=0")
											}
										}

										// Thought Transition Command - "potential collaboration"
										else if (transcript.trim().startsWith('potential collaborations')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												var collaborations = []
												outline.push({"Voice Command":"Potential Collaborations", "Intention":transcript.replace('potential collaborations', '').trim()})
												transcript = transcript.replace('potential collaborations', '').trim()
												console.log('Retrieved authors for ')
												for (ref in sources) {
													for (entity in sources[ref].references) {
														// console.log(sources[ref].references[entity])
														var authors = sources[ref].references[entity].author;
														// console.log(authors)
														for (author in authors) {
															var authorRef = [authors[author], ref];
															// console.log(authorRef)
															collaborations.push(authorRef)
														}
													}
												}
												var occurences = {};
												for (var i = 0; i < collaborations.length; i++) {
													if (typeof occurences[collaborations[i][0]] == "undefined") {
														occurences[collaborations[i][0]] = 1;
													} else {
															occurences[collaborations[i][0]]++;
														}
												}
												var authorCount = []
												for (var pi in occurences) {
													authorCount.push([pi, occurences[pi]])
												authorCount.sort(function compare(kv1, kv2) {
													return kv2[1] - kv1[1]
													})
												}

												for (author in authorCount) {
													for (collaboration in collaborations) {
														if (collaborations[collaboration][0] == authorCount[author][0]) {
															if (authorCount[author].includes(collaborations[collaboration][1])) {
																continue;
															}
															else {
																authorCount[author].push(collaborations[collaboration][1])
																// console.log(authorCount[author])
															}
														}
													}
												}
												// console.log(authorCount)
												// console.log(collaborations)
												var authorLabels = [];
												var keywordRanking = document.getElementsByTagName('text');
												for (textElement in keywordRanking) {
													var clusterText = keywordRanking[textElement].textContent;
													if (clusterText != "") {
														var clusterID = keywordRanking[textElement].__data__.id.toString();
														for (author in authorCount) {
															if (authorCount[author].slice(2,).includes(clusterID)) {
																if (authorLabels.includes(authorCount[author][0])) {
																	// console.log('Already used...')
																	continue;
																}
																else {
																	keywordRanking[textElement].textContent = authorCount[author][0]
																	// use this mapping to reverse changes with voice command (next function)
																	keywordAuthorMap[clusterText] = authorCount[author][0]
																	// console.log(keywordAuthorMap)
																	authorLabels.push(authorCount[author][0])
																	break;
																}
															}
														}
														// console.log(clusterText + ' ID ' + clusterID)
													}
												}
											}
										}

										// // Thought Transition Command - "affiliations"
										// else if (transcript.trim().startsWith('affiliations')) {
										//   if (count(transcript) > 1) {
										//     console.log('Command ignored, already executed.');
										//     continue;
										//   } else {
										//     var collaborations = [];
										//     transcript = transcript.replace('affilliations', '').trim()
										//     console.log('Retrieved affiliations')
										//     for (ref in sources) {
										//       for (entity in sources[ref].references) {
										//         // console.log(sources[ref].references[entity])
										//         var affils = sources[ref].references[entity].affiliations;
										//         // console.log(authors)
										//         for (affil in affils) {
										//           var affilRef = [affils[affil], ref];
										//           // console.log(affilRef)
										//           collaborations.push(affilRef)
										//         }
										//       }
										//     }
										//     var occurences = {};
										//     for (var i = 0; i < collaborations.length; i++) {
										//       if (typeof occurences[collaborations[i][0]] == "undefined") {
										//         occurences[collaborations[i][0]] = 1;
										//       } else {
										//           occurences[collaborations[i][0]]++;
										//         }
										//     }
										//     var affilCount = []
										//     for (var pi in occurences) {
										//       affilCount.push([pi, occurences[pi]])
										//     affilCount.sort(function compare(kv1, kv2) {
										//       return kv2[1] - kv1[1]
										//       })
										//     }
										//
										//     for (affil in affilCount) {
										//       for (collaboration in collaborations) {
										//         if (collaborations[collaboration][0] == affilCount[affil][0]) {
										//           if (affilCount[affil].includes(collaborations[collaboration][1])) {
										//             continue;
										//           }
										//           else {
										//             affilCount[affil].push(collaborations[collaboration][1])
										//             // console.log(authorCount[author])
										//           }
										//         }
										//       }
										//     }
										//     // console.log(authorCount)
										//     // console.log(collaborations)
										//     var affilLabels = [];
										//     var keywordRanking = document.getElementsByTagName('text');
										//     for (textElement in keywordRanking) {
										//       var clusterText = keywordRanking[textElement].textContent;
										//       if (clusterText != "") {
										//         var clusterID = keywordRanking[textElement].__data__.id.toString();
										//         for (affil in affilCount) {
										//           if (affilCount[affil].slice(2,).includes(clusterID)) {
										//             if (affilLabels.includes(affilCount[affil][0])) {
										//               // console.log('Already used...')
										//               continue;
										//             }
										//             else {
										//               keywordRanking[textElement].textContent = affilCount[affil][0]
										//               // use this mapping to reverse changes with voice command (next function)
										//               // console.log(keywordAuthorMap)
										//               affilLabels.push(affilCount[affil][0])
										//               break;
										//             }
										//           }
										//         }
										//         // console.log(clusterText + ' ID ' + clusterID)
										//       }
										//     }
										//   }
										// }


										// // DOM text content undo for author-to-keyword map
										// else if (transcript.trim().startsWith('concepts')) {
										//   var keywordRanking = document.getElementsByTagName('text');
										//   for (textElement in keywordRanking) {
										//     var clusterText = keywordRanking[textElement].textContent;
										//     if (clusterText != "") {
										//       // console.log(clusterText)
										//       for (value in Object.values(keywordAuthorMap)) {
										//         // console.log(Object.values(keywordAuthorMap)[value])
										//         if (Object.values(keywordAuthorMap)[value] == clusterText) {
										//           keywordRanking[textElement].textContent = Object.keys(keywordAuthorMap)[value]
										//         }
										//       }
										//     }
										//   }
										// }

										// References - "citation [keyword]"
										else if (transcript.trim().startsWith('citation')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											} else {
												outline.push({"Voice Command":"Citation", "Intention":transcript.replace('citation', '').trim()})
												transcript = transcript.replace('citation', '').trim()
												console.log('Retrieved references for ' + transcript)
												for (ref in sources) {
													if (sources[ref].concepts.slice(0,6).includes(transcript)) {
														for (entry in sources[ref].references) {
															var title = sources[ref].references[entry].title;
															var url = sources[ref].references[entry].html;
															outline.push({"Title":title, "URL":url})
														}
													}
												}
											}
										}

										// summarize outline before finishing
										else if (transcript.trim().startsWith('summary')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											}
											else {
											outline.push({"Voice Command":"Summary", "Intention":transcript.replace('summary', '').trim()})
											console.log('Command: ' + transcript)
											transcript = transcript.replace('summary', '')
											// call the save function to download outline locally
											// save();
											}
										}

										// research question(s) at beginning
										else if (transcript.trim().startsWith('research question')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											}
											else {
											outline.push({"Voice Command":"Research Question", "Intention":transcript.replace('research question', '').trim()})
											console.log('Command: ' + transcript)
											}
										}


										// finish outline and provide URL to user
										else if (transcript.trim().startsWith('finish outline')) {
											if (count(transcript) > 1) {
												console.log('Command ignored, already executed.');
												continue;
											}
											else {
											outline.push({"Voice Command":"Finish Outline"})
											console.log('Command: ' + transcript)
											// timestamp the outline
											var today = new Date();
											var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
											var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
											outline.push({"Date":date, "Time":time})
											// alert('What is your high-level summary for this search session? Say: "summary..." So I can record it in the outline.')
											}
										}


										else {
											if (count(transcript) > 1) {
												console.log('thought ignored, already transcribed.');
												continue;
											}
											else {
												outline.push({"Thought":transcript.trim()})
											}
										}
									}
								}
							}

							//$(floater)
					});
			 },1900);//end of setTimeout
			 return false;
			}else{
				alert( "No cluster has been selected.")
			}
		});
	});

<!-- back -->
$(function() {
	<!-- reclustering -->
		$('a#back').bind('click', function() {
			console.log("back width: " + width)
			var check = 0;
			d3.selectAll("circle").each(function(){
						if (this.style.filter != "url(\"#grayscale\")") {
							check += 1;
							//remove all the tabs for documents
							var cluster_id = this.id;
							}
						});
						// unselect all check boxes
		$('input[name="ids"]').prop('checked', false);

		$.getJSON($SCRIPT_ROOT + '/_back', { }, function(data) {

			if (data.cls.stage_alert == "first"){
				//console.log("first")
				alert( "Already the first stage.")
			}
			var new_data = [] ;
			data_length = data.cls.desc.length ;

			for (var i = 0 ; i < data_length ; i++ ) {
			temp_obj = {};
			keywords = "";
			word_length = data.cls.desc[i].length ;

			//formatting the data
			for (var j = 0 ; j < word_length ; j++) {
				if (j == 0) {
					keywords = data.cls.desc[i][j];
				} else {
					keywords = keywords + " " + data.cls.desc[i][j];
				}
			}
			temp_obj["keywords"]= keywords;
			temp_obj["edges"] = data.cls.edges;
			temp_obj["count"] = data.cls.id2freq[i];
			temp_obj["id"] = i.toString();
			temp_obj["cx"] = data.cls.xy[i][0];
			temp_obj["cy"] = data.cls.xy[i][1];
			temp_obj["hue"] = data.cls.hue[i];
			temp_obj["satr"] = data.cls.satr[i];
			temp_obj["val"] = data.cls.val[i];
			temp_obj["response_time"] = data.cls.response_time[i];
			var members = data.cls.id2members[i];
			temp_obj["members"] = members;
			temp_obj["chosen"] = data.cls.chosen[i];
			temp_obj["stage_alert"] = data.cls.stage_alert;
			//console.log("id2members="+members);
			var bibs_ = {};
			for (var j = 0; j < members.length; j++){
				var member = members[j];
				//console.log(data.cls.bibs[member].title);
				bibs_[j]={};
				bibs_[j]["title"] = data.cls.bibs[member].title;
				bibs_[j]["body_toshow"] = data.cls.bibs[member].body_toshow;
				bibs_[j]["author"] = data.cls.bibs[member].author;
				bibs_[j]["journal"] = data.cls.bibs[member].journal;
				bibs_[j]["pdate"] = data.cls.bibs[member].pdate;
				bibs_[j]["pmid"] = data.cls.bibs[member].pmid;
				bibs_[j]["html"] = data.cls.bibs[member].html;
			}
			//console.log("bibs_="+bibs_)
			temp_obj["bibs"] = bibs_;
			new_data.push(temp_obj);
		}

		//remove the old svg
		d3.select("svg").remove();

		//add heutistic table
					var heuristicTable = tabulate([{'Distance':'Very Similar','Meaning':'More than or equal to 75% semantic similarity'}, {'Distance':'Similar','Meaning':'Between 50% and 75% semantic similarity'},{'Distance':'Distant', 'Meaning':'Less than 50% semantic similarity'}], ["Distance", "Meaning"]);

					heuristicTable.selectAll("tbody tr")
								.sort(function(a, b) {
												return d3.descending(a.close, b.close);
								});

					heuristicTable.selectAll("thead th")
								.text(function(column) {
												return column.charAt(0).toUpperCase()+column.substr(1);
								});


		//new svg
		var svg = d3.select(".bubbleChart").append("svg").attr("width",width)
						.attr("height",height)

		var rect = d3.select('svg').append("rect")
		 .attr("id","background_rect")
		 .attr("fill","white")
		 .attr("height",height)
		 .attr("width", width);

		var dataset = new_data;

		var node = svg.selectAll(".node")
				.data(dataset)
				.enter();
				
		//modify dataset for text
		var modified_dataset = modify_data(dataset, width, height);

		//Add the SVG Text Element to the svgContainer
		var texts = svg.selectAll("text")
						.data(modified_dataset[0])
						.enter()
						.append("text");
				
		//textualize
		function textualize (d) {

			var selection = d3.select(this);
			selection.text(function (d) {
					return d.keyword;
			})
			.attr("id", function(d){return(d.id)})
			.style('-webkit-user-select', 'none')
			.style('-khtml-user-select', 'none')
			.style('-moz-user-select', 'none')
			.style('-ms-user-select', 'none')
			.style('-o-user-select', 'none')
			.style('user-select', 'none')
			.attr("font-family", "sans-serif")
			.attr("font-size", function (d) {
					return d.size * 1.5;
			})
			.attr("fill", "grey")
			.attr("text-anchor", "middle")
			.attr("text-transform", "capitalize")
			.attr("x",600)
			.attr("y",function(d){
					return (d.y-300)/600*100+300;
			})
			.on('mouseover', mouseover)
			//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
			.on('mouseout', mouseout)
			.transition()
			.attr("x", function (d) {
					return d.x;
			})
			.attr("y", function (d) {
					return d.y;
			})
			.duration(500);
			};

			var textLabels = texts.each(textualize, d);

		var g = node
				.append("g");

						//adding new circles
						var circle_xy = {};
						var circle = g.append("circle")
							.attr("id", function(d){return d.id;} )
							//.attr("pulse",false)
							.attr("chosen", function(d){return d.chosen;})
							.attr("fill", function(d){
								return (d3.hsl(d.hue, d.satr, d.val ));
							 })
							.attr("style",'filter:url(\"#grayscale\")')
							.attr("cx", 600)
							.attr("cy", 300)
							.attr("r", function(d) { return Math.sqrt(d.count/(modified_dataset[1]*1.2))*270; })
							.attr("fill-opacity","0.20")
							.on('mouseover', mouseover)
							//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
							.on('mouseout', mouseout)
							.on('contextmenu', function(d){
								var selected_bibs = 0
								d3.selectAll('circle').each(function(d){
									var bibs_length = 0;
									if(this.style.filter != "url(\"#grayscale\")"){
										var bibs_length = d.members.length;
									}
									selected_bibs += bibs_length;
								})
								//console.log("selected_bibs:")
								//console.log(selected_bibs)
								if(selected_bibs>=10){
									//console.log(dataset[0])
									if(dataset[0]['stage_alert'] == "about to be the first"){
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom in', 'Close Menu');
									}else{
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom in', 'Zoom out', 'Close Menu');
									}
								}else{
									if(dataset[0]['stage_alert'] == "about to be the first"){
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Close Menu');
									}else{
										var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom out', 'Close Menu');
									}
								}
									d3.event.preventDefault();
									menu(d3.mouse(this)[0], d3.mouse(this)[1], d.id);
							})
							.transition()
							.attr("cx", function(d) {return (200 + d.cx * 0.75 *(width-200));})
							.attr("cy", function(d) { return (150 + d.cy * 0.75 *(height-200)); })
							.duration(500);

		var zoom = d3.zoom()
			.scaleExtent([1, 10])
			.on("zoom", function(){
				var e = d3.event;
				tx = Math.min(0, Math.max(e.transform.x, width - width * e.transform.k)),
				ty = Math.min(0, Math.max(e.transform.y, height - height * e.transform.k));
				g.attr('transform', [
						"translate(" + [tx, ty] + ")",
						"scale(" + e.transform.k + ")"
			 ].join(" "));
				texts.attr('transform', [
						"translate(" + [tx, ty] + ")",
						"scale(" + e.transform.k + ")"
			 ].join(" "));
		 });

		//svg.call(zoom);

		d3.select(self.frameElement)
						.style("height", height + "px");

		var svg = d3.select("svg");
		var defs = svg.append("defs");

		var grayscalefilter = defs.append('svg:filter')
			.attr('id','grayscale');
		grayscalefilter.append('svg:feColorMatrix')
			.attr('type','matrix')
			.attr('values','0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0');

		d3.selectAll("text").on("click", function(d) {

			var text_id = d.id;

			d3.selectAll('circle[id="'+text_id+'"]').each(choose_bubbles,d);
			//$(floater)
		});//end of text click

			d3.selectAll("circle").on("click",choose_bubbles);
			//$(floater)
			//console.log(data)
			d3.selectAll("circle").each(function(d){
				if (d.chosen == 1){
					//console.log("choose this circle")
					d3.selectAll('circle[id="' + d.id + '"]').each(choose_bubbles,d);
				}

			})
		});
	}); //end of reclustering function
}); //end of back function

$(document).ready(function() {

	// alert('Remember to state your research question. Say: "Research Question..."');
	// user query
	var query = '{{q|safe}}'
	outline.push({"Search Engine":"pattie.unc.edu"})
	outline.push({"Query":query.trim()})
	// get the cluster labels for concept navigation
	var concepts = {{cluster_desc|safe}};
	// get the references for concept navigation
	var sources = {{sources|safe}};
	// use this mapping to undo DOM text content changes (author-to-keyword map)
	var keywordAuthorMap = {};
	// count console transcript to prevent duplicate command executions
	var count = (function() {
		var counter = {};
		return function(v) {
			return (counter[v] = (counter[v] || 0) + 1);
		}
	}());
	// make transcript global and changeable
	// have PATTIE always listening
	recognition.continuous = true;
	// extract transcript object as query
	recognition.onresult = function(event) {
	// console.log(event)
	transcript = event.results[0][0].transcript.toLowerCase()
	if (transcript === 'search again') {
		// go back to main page to search again
		window.history.back()
		// don't execute anything until proper command is given
	} else {
			for (recording in event.results) {
				console.log(event.results[recording])
				var transcript = event.results[recording][0].transcript.toLowerCase().trim();
				console.log('Thought Transition Command: ' + transcript)

				if (transcript === ' search again') {
					window.history.back();
				}

				// voice command for displaying/removing connections (edges)
				else if (transcript.trim().trim().startsWith('similar')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Similar", "Intention":transcript.replace('similar', '').trim()})
						transcript = transcript.replace('similar', '')
						for (cluster in concepts) {
							// console.log(concepts[cluster])
							if (concepts[cluster].includes(transcript.trim().toLowerCase())) {
								console.log(transcript + ' is in cluster ' + cluster)
								VoiceEdges(cluster);
							}
						}
					}
				}

				// remove network edges by voice
				else if (transcript.trim().trim().startsWith('remove')) {
					console.log('Command: ' + transcript)
					VoiceEdgesRemove(d);
				}


				// Thought Transition Command - "ontology [keyword]": baseURL: http://amigo.geneontology.org/amigo/search/ontology?q=[keyword]
				else if (transcript.trim().startsWith('ontology')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Ontology", "Intention":transcript.replace('ontology', '').trim()})
						transcript = transcript.replace('ontology', '')
						console.log('Retrieved gene ontology information for ' + transcript)
						ontology = window.open("http://amigo.geneontology.org/amigo/search/ontology?q="+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
						outline.push("Ontology Source: http://amigo.geneontology.org/amigo/search/ontology?q="+transcript.trim().toLowerCase())
					}
				}

				// Thought Transition Command - "evidence [keyword]" : baseURL: http://amigo.geneontology.org/amigo/search/annotation?q=[keyword]
				else if (transcript.trim().startsWith('evidence')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Evidence", "Intention":transcript.replace('evidence', '').trim()})
						transcript = transcript.replace('evidence', '')
						console.log('Retrieved gene annotation information for ' + transcript)
						window.open("http://amigo.geneontology.org/amigo/search/annotation?q="+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
						outline.push("Evidence Source: http://amigo.geneontology.org/amigo/search/annotation?q="+transcript.trim().toLowerCase())
					}
				}

				// source: https://www.genome.jp/kegg/pathway.html
				// Thought Transition Command - "pathway [keyword]''
				else if (transcript.trim().startsWith('disease pathway')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Disease Pathway", "Intention":transcript.replace('disease pathway', '').trim()})
						transcript = transcript.replace('disease pathway', '')
						console.log('Retrieved disease pathway information for ' + transcript)
						window.open("https://www.kegg.jp/kegg-bin/search_pathway_text?map=hsa&"+"keyword="+transcript.trim().toLowerCase()+"&mode=1&viewImage=true","_blank","width=1250,height=800");
						outline.push("Disease Pathway Source: https://www.kegg.jp/kegg-bin/search_pathway_text?map=hsa&"+"keyword="+transcript.trim().toLowerCase()+"&mode=1&viewImage=true")
					}
				}

				// Thought Transition Command - "protein pathway [keyword]''
				else if (transcript.trim().startsWith('protein pathway')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Protein Pathway", "Intention":transcript.replace('protein pathway', '').trim()})
						transcript = transcript.replace('protein pathway', '')
						window.open("https://reactome.org/content/query?q="+transcript.trim().toLowerCase()+"&species=Homo+sapiens&types=Protein&cluster=true","_blank","width=1250,height=800");
						console.log('Retrieved protein pathway information for ' + transcript)
						outline.push("Protein Pathway Source: https://reactome.org/content/query?q="+transcript.trim().toLowerCase()+"&species=Homo+sapiens&types=Protein&cluster=true")
					}
				}

				// Thought Transition Command - "drug [keyword]''
				else if (transcript.trim().startsWith('drug')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Drug", "Intention":transcript.replace('drug', '').trim()})
						transcript = transcript.replace('drug', '')
						window.open("https://www.drugbank.ca/unearth/q?utf8=✓&searcher=drug&query="+transcript.trim().toLowerCase()+"&approved=1&investigational=1&experimental=1&us=0&us=1&ca=0&eu=0&commit=Apply+Filter","_blank","width=1250,height=800");
						console.log('Retrieved drug information for ' + transcript)
						outline.push("Drug Source: https://www.drugbank.ca/unearth/q?utf8=✓&searcher=drug&query="+transcript.trim().toLowerCase()+"&approved=1&investigational=1&experimental=1&us=0&us=1&ca=0&eu=0&commit=Apply+Filter")
					}
				}



				// source: https://genemania.org/
				// Thought Transition Command - "network [keyword]"
				else if (transcript.trim().startsWith('network')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Network", "Intention":transcript.replace('network', '').trim()})
						transcript = transcript.replace('network', '')
						console.log('Retrieved gene network information for ' + transcript)
						window.open("https://genemania.org/search/homo-sapiens/"+transcript.trim().toLowerCase(),"_blank","width=1250,height=800");
						outline.push("Network Model Source: https://genemania.org/search/homo-sapiens/"+transcript.trim().toLowerCase())
					}
				}


				// source: clinicaltrials.gov
				// Thought Transition Command - "clinical trial [keyword]"
				else if (transcript.trim().startsWith('clinical trial')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Clinical Trial", "Intention":transcript.replace('clinical trial', '').trim()})
						transcript = transcript.toLowerCase().replace('clinical trial', '')
						console.log('Retrieved active clinical trials for condition ' + transcript)
						window.open("https://clinicaltrials.gov/ct2/results?cond="+transcript+"&Search=Apply&recrs=b&recrs=a&recrs=f&age_v=&gndr=&type=&rslt=","_blank","width=1250,height=800");
						outline.push("Clinical Trial Source: https://clinicaltrials.gov/ct2/results?cond="+transcript+"&Search=Apply&recrs=b&recrs=a&recrs=f&age_v=&gndr=&type=&rslt=")
					}
				}

				// source: Google
				// Thought Transition Command - "Google [keyword]"
				else if (transcript.trim().startsWith('google')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Google", "Intention":transcript.replace('google', '').trim()})
						transcript = transcript.toLowerCase().replace('google', '')
						console.log('Retrieved Google web search for ' + transcript)
						window.open("https://www.google.com/search?q="+transcript,"_blank","width=1250,height=800");
						outline.push("Google Result Source: https://www.google.com/search?q="+transcript)
					}
				}

				// source: YouTube
				// Thought Transition Command - "YouTube [keyword]"
				else if (transcript.trim().startsWith('youtube')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"YouTube", "Intention":transcript.replace('youtube', '').trim()})
						transcript = transcript.toLowerCase().replace('youtube', '')
						console.log('Retrieved YouTube search for ' + transcript)
						window.open("https://www.youtube.com/results?search_query="+transcript,"_blank","width=1250,height=800");
						outline.push("YouTube Result Source: https://www.youtube.com/results?search_query="+transcript)
					}
				}

				// source: https://grants.nih.gov/grants/oer.htm
				// Thought Transition Command - "grant [keyword]"
				else if (transcript.trim().startsWith('grant')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Grant", "Intention":transcript.replace('grant', '').trim()})
						transcript = transcript.toLowerCase().replace('grant', '')
						console.log('Retrieved YouTube search for ' + transcript)
						window.open("https://grants.nih.gov/funding/SearchGuide/index.html?query="+transcript+"&x=0&y=0#/","_blank","width=1250,height=800");
						outline.push("Grant Funding Source: https://grants.nih.gov/funding/SearchGuide/index.html?query="+transcript+"&x=0&y=0#/")
					}
				}

				// source: https://academic.microsoft.com/
				// Thought Transition Command - "authority [keyword]"
				else if (transcript.trim().startsWith('authority')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Authority", "Intention":transcript.replace('authority', '').trim()})
						transcript = transcript.toLowerCase().replace('authority', '')
						console.log('Retrieved authority information for ' + transcript)
						window.open("https://academic.microsoft.com/search?q="+transcript+"&f=&orderBy=0","_blank","width=1250,height=800");
						outline.push("Authority Source: https://academic.microsoft.com/search?q="+transcript+"&f=&orderBy=0")
					}
				}

				// Thought Transition Command - "potential collaboration"
				else if (transcript.trim().startsWith('potential collaborations')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						var collaborations = []
						outline.push({"Voice Command":"Potential Collaborations", "Intention":transcript.replace('potential collaborations', '').trim()})
						transcript = transcript.replace('potential collaborations', '').trim()
						console.log('Retrieved authors for ')
						for (ref in sources) {
							for (entity in sources[ref].references) {
								//console.log(sources[ref].references[entity])
								var authors = sources[ref].references[entity].author;
								//console.log(authors)
								for (author in authors) {
									var authorRef = [authors[author], ref];
									// console.log(authorRef)
									collaborations.push(authorRef)
								}
							}
						}
						var occurences = {};
						for (var i = 0; i < collaborations.length; i++) {
							if (typeof occurences[collaborations[i][0]] == "undefined") {
								occurences[collaborations[i][0]] = 1;
							} else {
									occurences[collaborations[i][0]]++;
								}
						}
						var authorCount = []
						for (var pi in occurences) {
							authorCount.push([pi, occurences[pi]])
						authorCount.sort(function compare(kv1, kv2) {
							return kv2[1] - kv1[1]
							})
						}

						for (author in authorCount) {
							for (collaboration in collaborations) {
								if (collaborations[collaboration][0] == authorCount[author][0]) {
									if (authorCount[author].includes(collaborations[collaboration][1])) {
										continue;
									}
									else {
										authorCount[author].push(collaborations[collaboration][1])
										// console.log(authorCount[author])
									}
								}
							}
						}
						// console.log(authorCount)
						// console.log(collaborations)
						var authorLabels = [];
						var keywordRanking = document.getElementsByTagName('text');
						for (textElement in keywordRanking) {
							var clusterText = keywordRanking[textElement].textContent;
							if (clusterText != "") {
								var clusterID = keywordRanking[textElement].__data__.id.toString();
								for (author in authorCount) {
									if (authorCount[author].slice(2,).includes(clusterID)) {
										if (authorLabels.includes(authorCount[author][0])) {
											// console.log('Already used...')
											continue;
										}
										else {
											keywordRanking[textElement].textContent = authorCount[author][0]
											// use this mapping to reverse changes with voice command (next function)
											keywordAuthorMap[clusterText] = authorCount[author][0]
											// console.log(keywordAuthorMap)
											authorLabels.push(authorCount[author][0])
											break;
										}
									}
								}
								// console.log(clusterText + ' ID ' + clusterID)
							}
						}
					}
				}

				// // Thought Transition Command - "affiliations"
				// else if (transcript.trim().startsWith('affiliations')) {
				//   if (count(transcript) > 1) {
				//     console.log('Command ignored, already executed.');
				//     continue;
				//   } else {
				//     var collaborations = [];
				//     transcript = transcript.replace('affilliations', '').trim()
				//     console.log('Retrieved affiliations')
				//     for (ref in sources) {
				//       for (entity in sources[ref].references) {
				//         // console.log(sources[ref].references[entity])
				//         var affils = sources[ref].references[entity].affiliations;
				//         // console.log(authors)
				//         for (affil in affils) {
				//           var affilRef = [affils[affil], ref];
				//           // console.log(affilRef)
				//           collaborations.push(affilRef)
				//         }
				//       }
				//     }
				//     var occurences = {};
				//     for (var i = 0; i < collaborations.length; i++) {
				//       if (typeof occurences[collaborations[i][0]] == "undefined") {
				//         occurences[collaborations[i][0]] = 1;
				//       } else {
				//           occurences[collaborations[i][0]]++;
				//         }
				//     }
				//     var affilCount = []
				//     for (var pi in occurences) {
				//       affilCount.push([pi, occurences[pi]])
				//     affilCount.sort(function compare(kv1, kv2) {
				//       return kv2[1] - kv1[1]
				//       })
				//     }
				//
				//     for (affil in affilCount) {
				//       for (collaboration in collaborations) {
				//         if (collaborations[collaboration][0] == affilCount[affil][0]) {
				//           if (affilCount[affil].includes(collaborations[collaboration][1])) {
				//             continue;
				//           }
				//           else {
				//             affilCount[affil].push(collaborations[collaboration][1])
				//             // console.log(authorCount[author])
				//           }
				//         }
				//       }
				//     }
				//     // console.log(authorCount)
				//     // console.log(collaborations)
				//     var affilLabels = [];
				//     var keywordRanking = document.getElementsByTagName('text');
				//     for (textElement in keywordRanking) {
				//       var clusterText = keywordRanking[textElement].textContent;
				//       if (clusterText != "") {
				//         var clusterID = keywordRanking[textElement].__data__.id.toString();
				//         for (affil in affilCount) {
				//           if (affilCount[affil].slice(2,).includes(clusterID)) {
				//             if (affilLabels.includes(affilCount[affil][0])) {
				//               // console.log('Already used...')
				//               continue;
				//             }
				//             else {
				//               keywordRanking[textElement].textContent = affilCount[affil][0]
				//               // use this mapping to reverse changes with voice command (next function)
				//               // console.log(keywordAuthorMap)
				//               affilLabels.push(affilCount[affil][0])
				//               break;
				//             }
				//           }
				//         }
				//         // console.log(clusterText + ' ID ' + clusterID)
				//       }
				//     }
				//   }
				// }


				// // DOM text content undo for author-to-keyword map
				// else if (transcript.trim().startsWith('concepts')) {
				//   var keywordRanking = document.getElementsByTagName('text');
				//   for (textElement in keywordRanking) {
				//     var clusterText = keywordRanking[textElement].textContent;
				//     if (clusterText != "") {
				//       // console.log(clusterText)
				//       for (value in Object.values(keywordAuthorMap)) {
				//         // console.log(Object.values(keywordAuthorMap)[value])
				//         if (Object.values(keywordAuthorMap)[value] == clusterText) {
				//           keywordRanking[textElement].textContent = Object.keys(keywordAuthorMap)[value]
				//         }
				//       }
				//     }
				//   }
				// }

				// References - "citation [keyword]"
				else if (transcript.trim().startsWith('citation')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					} else {
						outline.push({"Voice Command":"Citation", "Intention":transcript.replace('citation', '').trim()})
						transcript = transcript.replace('citation', '').trim()
						console.log('Retrieved references for ' + transcript)
						for (ref in sources) {
							if (sources[ref].concepts.slice(0,6).includes(transcript)) {
								for (entry in sources[ref].references) {
									var title = sources[ref].references[entry].title;
									var url = sources[ref].references[entry].html;
									outline.push({"Title":title, "URL":url})
								}
							}
						}
					}
				}

				// summarize outline before finishing
				else if (transcript.trim().startsWith('summary')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					}
					else {
					outline.push({"Voice Command":"Summary", "Intention":transcript.replace('summary', '').trim()})
					console.log('Command: ' + transcript)
					transcript = transcript.replace('summary', '')
					// call the save function to download outline locally
					// save();
					}
				}

				// research question(s) at beginning
				else if (transcript.trim().startsWith('research question')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					}
					else {
					outline.push({"Voice Command":"Research Question", "Intention":transcript.replace('research question', '').trim()})
					console.log('Command: ' + transcript)
					}
				}


				// finish outline and provide URL to user
				else if (transcript.trim().startsWith('finish outline')) {
					if (count(transcript) > 1) {
						console.log('Command ignored, already executed.');
						continue;
					}
					else {
					outline.push({"Voice Command":"Finish Outline"})
					console.log('Command: ' + transcript)
					// timestamp the outline
					var today = new Date();
					var date = today.getFullYear()+'-'+(today.getMonth()+1)+'-'+today.getDate();
					var time = today.getHours() + ":" + today.getMinutes() + ":" + today.getSeconds();
					outline.push({"Date":date, "Time":time})
					// alert('What is your high-level summary for this search session? Say: "summary..." So I can record it in the outline.')
					}
				}


				else {
					if (count(transcript) > 1) {
						console.log('thought ignored, already transcribed.');
						continue;
					}
					else {
						outline.push({"Thought":transcript.trim()})
					}
				}
			}
		}
	}

	console.log("ready width: " + width)
	//acquiring the original data
	var bibs = {{bibs|safe}};
	var hue = {{hue|safe}};
	var satr = {{satr|safe}};
	var val = {{val|safe}};
	var data_length = {{id2freq|length}};
	var edges = {{ edges|tojson|safe }};

	//add heutistic table
					var heuristicTable = tabulate([{'Distance':'Very Similar','Meaning':'More than or equal to 75% semantic similarity'}, {'Distance':'Similar','Meaning':'Between 50% and 75% semantic similarity'},{'Distance':'Distant', 'Meaning':'Less than 50% semantic similarity'}], ["Distance", "Meaning"]);

					heuristicTable.selectAll("tbody tr")
								.sort(function(a, b) {
												return d3.descending(a.close, b.close);
								});

					heuristicTable.selectAll("thead th")
								.text(function(column) {
												return column.charAt(0).toUpperCase()+column.substr(1);
								});

	var svg = d3.select(".bubbleChart").append("svg").attr("width",width)
					.attr("height",height)

	var rect = d3.select('svg').append("rect")
	 .attr("id","background_rect")
	 .attr("fill","white")
	 .attr("fill-opacity","0.20")
	 .attr("height",height)
	 .attr("width", width);

	var dataset =  [

						{% for id in id2freq %}

						{ keywords: "{% for w in cluster_desc[id] %}{{w}} {% endfor %}", count: {{ id2freq[id] }}, id: "{{id}}" , members:{{id2members[id]|safe}}, cx: {{ xy[loop.index - 1][0]  }}, cy: {{ xy[loop.index - 1][1] }}, hue:{{hue[id]|safe}}, satr:{{satr[id]|safe}}, val:{{val[id]|safe}}, edges: {{ edges|tojson|safe }}},

						{% endfor %}

						];

	//building the bibs and update dataset
	for (var i=0; i<data_length; i++){
		var members = dataset[i].members;
		var bibs_ = {}
		for (var j=0; j<members.length; j++){
			var member = members[j];
			//console.log(data.cls.bibs[member].title);
			bibs_[j]={};
			bibs_[j]["title"] = bibs[member].title;
			bibs_[j]["body_toshow"] = bibs[member].body_toshow;
			bibs_[j]["author"] = bibs[member].author;
			bibs_[j]["journal"] = bibs[member].journal;
			bibs_[j]["pdate"] = bibs[member].pdate;
			bibs_[j]["pmid"] = bibs[member].pmid;
			bibs_[j]["html"] = bibs[member].html;
		}
		dataset[i]["bibs"] = bibs_
		}

	var node = svg.selectAll(".node")
			.data(dataset)
			.enter();

 //console.log(dataset);
	var modified_dataset = modify_data(dataset, width, height);
 //console.log(modified_dataset);

	//bydate(dataset);
	
	//Add the SVG Text Element to the svgContainer
	var texts = svg.selectAll("text")
			.data(modified_dataset[0])
			.enter()
			.append("text");
			
	//textualize
	function textualize (d) {

		var selection = d3.select(this);
		selection.text(function (d) {
				return d.keyword;
		})
		.attr("id", function(d){return(d.id)})
		.style('-webkit-user-select', 'none')
		.style('-khtml-user-select', 'none')
		.style('-moz-user-select', 'none')
		.style('-ms-user-select', 'none')
		.style('-o-user-select', 'none')
		.style('user-select', 'none')
		.attr("font-family", "sans-serif")
		.attr("font-size", function (d) {
				return d.size * 1.5;
		})
		.attr("fill", "grey")
		.attr("text-anchor", "middle")
		.attr("text-transform", "capitalize")
		.attr("x",600)
		.attr("y",function(d){
				return (d.y-300)/600*100+300;
		})
		.on('mouseover', mouseover)
		//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
		.on('mouseout', mouseout)
		.transition()
		.attr("x", function (d) {
				return d.x;
		})
		.attr("y", function (d) {
				return d.y;
		})
		.duration(500);
		};


	//Add SVG Text Element Attributes
	var textLabels = texts.each(textualize, d);


	var g = node
			.append("g");


			var circle = g.append("circle")
				.attr("id", function(d){return(d.id)})
				.attr("name", function(d){return(d.id)})
				//.attr("pulse",false)
				.attr("fill", function(d){return (d3.hsl(hue[d.id], satr[d.id], val[d.id] ))})
				.attr("fill-opacity","0.20")
				.attr("style",'filter:url(\"#grayscale\")')
				.attr("cx", 600)
				.attr("cy", 300)
				.attr("r", function(d) { return Math.sqrt(d.count/(modified_dataset[1]*1.2))*270; })
				.on('mouseover', mouseover)
				//.on('mousemove', function(){return (tooltip.style("top", (event.pageY-10)+"px").style("left",(event.pageX+10)+"px"));})
				.on('mouseout', mouseout)
				.on('contextmenu', function(d){
					var selected_bibs = 0
					d3.selectAll('circle').each(function(d){
						var bibs_length = 0;
						if(this.style.filter != "url(\"#grayscale\")"){
							var bibs_length = d.members.length;
						}
						selected_bibs += bibs_length;
					})
					//console.log("selected_bibs:")
					//console.log(selected_bibs)
					if(selected_bibs>=10){
						var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Zoom in', 'Close Menu');
					}else{
						var menu = contextMenu().items('Show Documents', 'Show Edges', 'Hide All Edges', 'Close Menu');
					}
						d3.event.preventDefault();
						menu(d3.mouse(this)[0], d3.mouse(this)[1], d.id);
				})
				.transition()
				.attr("cx", function(d) { return (200 + d.cx * 0.75 *(width-200)); })
				.attr("cy", function(d) { return (150 + d.cy * 0.75 *(height-200)); })
				.duration(500);

		var zoom = d3.zoom()
			.scaleExtent([1, 10])
			.on("zoom", function(){
				var e = d3.event;
				tx = Math.min(0, Math.max(e.transform.x, width - width * e.transform.k)),
				ty = Math.min(0, Math.max(e.transform.y, height - height * e.transform.k));
				g.attr('transform', [
						"translate(" + [tx, ty] + ")",
						"scale(" + e.transform.k + ")"
			 ].join(" "));
				texts.attr('transform', [
						"translate(" + [tx, ty] + ")",
						"scale(" + e.transform.k + ")"
			 ].join(" "));
		 });

		//svg.call(zoom);

		d3.select(self.frameElement)
			.style("height", height + "px");

		var svg = d3.select("svg");
		var defs = svg.append("defs");

		var grayscalefilter = defs.append('svg:filter')
			.attr('id','grayscale');
		grayscalefilter.append('svg:feColorMatrix')
			.attr('type','matrix')
			.attr('values','0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0.3333 0.3333 0.3333 0 0 0 0 0 1 0');



		d3.selectAll("text").on("click", function(d) {

			var text_id = d.id;

			d3.selectAll('circle[id="'+text_id+'"]').each(choose_bubbles,d);
			//$(floater)
		});//end of text click

			d3.selectAll("circle").on("click",choose_bubbles);
			//$(floater)


});

}



// initialize voice recognition for global navigation
var recognition = new webkitSpeechRecognition();
recognition.start();
// complex data structure that will organize the voice transcript
var outline = []
// continuous microphone
recognition.onend = function() {
	recognition.start();
}

// function to save outline locally (called in "summary" function)
function save() {
	// send html content back to python for processing into Jupyter Notebook
	$.ajax({
					type: "POST",
					contentType: "application/json;charset=utf-8",
					url: "/notebook",
					traditional: "true",
					data: JSON.stringify(outline),
					dataType: "json"
					});
	}


</script>


<form name="Go" action = "{{ url_for('cluster_voice') }}" method="POST" enctype="multipart/form-data" style="text-align:left" id="usrform">
<!-- change input to value="{{ query }}" for non-voice -->
<input type="text" name="query" id="query" value="{{ query }}" style="margin-left:7px; width:35%; height:40px; position:relative; z-index:99;" autofocus>

<input id='Explore' style='background:DodgerBlue;color:white;opacity:.70;height:40px; position:relative; z-index:99;' type=submit value="Search">
<!-- <div class = 'select'> -->
<select style='text-align:center;color:white;background-color:white;opacity:0.0' name="dataset_opt" id='dataset_opt'>
		<option value="PubMedAPI"></option>
		<!-- <option value="GoogleAPI3">Basic Sciences</option>
		<option value="GoogleAPI">Computer & Information Sciences</option>
		<option value="GoogleAPI2">Government & Academia</option>
		<option value="NewsAPI">News</option> -->
</select>
<div class = 'select'>
		<select name="field" id='field' style="visibility:hidden">
				<option value="All fields" defaultOpen>All fields</option>
		</select>
		<!--<div class="select__arrow"></div>-->
</div>

<div id="cluster" class="cluster">
		<div class="bubbleChart" id="tabs-cluster"></div>
</div>

<div class=buttons style='visibility:hidden'>
		<p class="button" style="text-align:left;">
	<a class="btn" onclick='goHome()' id=home>Search Again</a>
	<a class="btn" href=# id=back>Zoom Out</a>
	<a class="btn" href=# id=calculate>Zoom In</a>
	<!--<a class="btn" href=# id=bydate>ByDate</a>-->
		</p>
</div>


{% endblock %}
